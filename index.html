<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #2d3b52;
            --accent-blue: #60a5fa;
            --accent-green: #34d399;
            --accent-red: #f87171;
            --accent-orange: #fb923c;
            --accent-yellow: #fbbf24;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .container { max-width: 1920px; margin: 0 auto; padding: 30px; }
        .header { background: var(--bg-secondary); border-radius: 12px; padding: 35px; margin-bottom: 25px; border: 1px solid var(--border-color); }
        .header h1 { font-size: 2.2rem; font-weight: 700; margin-bottom: 8px; }
        .header .subtitle { font-size: 1rem; color: var(--text-secondary); }
        .upload-section { background: var(--bg-secondary); border: 2px dashed var(--border-color); border-radius: 12px; padding: 45px; margin-bottom: 30px; text-align: center; }
        .upload-section.dragover { border-color: var(--accent-blue); background: rgba(96, 165, 250, 0.05); }
        .upload-label { display: inline-block; padding: 14px 40px; background: var(--accent-blue); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; }
        .upload-label:hover { background: #3b82f6; transform: translateY(-2px); }
        #fileInput { display: none; }
        .current-file { margin-top: 15px; padding: 10px 20px; background: rgba(52, 211, 153, 0.1); border: 1px solid var(--accent-green); border-radius: 8px; display: inline-block; color: var(--accent-green); }
        .filters-section { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 25px; }
        .filters-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filters-header h3 { font-size: 1.2rem; }
        .filter-status { color: var(--accent-blue); font-size: 0.9rem; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; margin-bottom: 18px; }
        .filter-group label { font-size: 0.75rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; display: block; }
        .filter-group select, .filter-group input { width: 100%; padding: 11px 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.95rem; cursor: pointer; }
        .filter-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .btn { padding: 9px 22px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-warning { background: var(--accent-orange); color: white; }
        .btn-icon { display: flex; align-items: center; gap: 8px; }
        .dashboard-content { display: none; }
        .dashboard-content.active { display: block; }
        .layout-controls { display: flex; gap: 10px; justify-content: flex-end; margin-bottom: 20px; flex-wrap: wrap; }
        .widgets-container { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .draggable-widget { background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 12px; overflow: hidden; transition: all 0.3s; }
        .draggable-widget.hidden { display: none; }
        .draggable-widget.dragging { opacity: 0.5; transform: rotate(2deg); border-color: var(--accent-blue); }
        .draggable-widget.drag-over { border-color: var(--accent-green); border-style: dashed; }
        .widget-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; background: linear-gradient(135deg, rgba(96, 165, 250, 0.1) 0%, rgba(52, 211, 153, 0.05) 100%); border-bottom: 1px solid var(--border-color); cursor: move; user-select: none; }
        .widget-header:hover { background: linear-gradient(135deg, rgba(96, 165, 250, 0.15) 0%, rgba(52, 211, 153, 0.08) 100%); }
        .widget-title { display: flex; align-items: center; gap: 12px; font-size: 1.3rem; font-weight: 700; }
        .drag-handle { font-size: 1.2rem; color: var(--text-secondary); cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .widget-controls { display: flex; gap: 10px; }
        .widget-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
        .widget-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); background: rgba(96, 165, 250, 0.1); }
        .widget-content { padding: 25px; }
        .tab-container { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.3s; border-bottom: 3px solid transparent; margin-bottom: -6px; }
        .tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; }
        .kpi-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 24px; transition: all 0.3s; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .kpi-card.critical { border-color: var(--accent-red); background: rgba(248, 113, 113, 0.05); }
        .kpi-card.warning { border-color: var(--accent-orange); }
        .kpi-card.success { border-color: var(--accent-green); }
        .kpi-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; margin-bottom: 10px; }
        .kpi-value { font-family: monospace; font-size: 2.8rem; font-weight: 700; line-height: 1; }
        .kpi-card:nth-child(1) .kpi-value { color: var(--accent-blue); }
        .kpi-card:nth-child(2) .kpi-value { color: var(--accent-red); }
        .kpi-card:nth-child(3) .kpi-value { color: var(--accent-green); }
        .kpi-card:nth-child(4) .kpi-value { color: var(--accent-orange); }
        .kpi-subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; }
        .overview-charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .chart-card { background: var(--bg-card); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .chart-card h3 { margin-bottom: 15px; font-size: 1.1rem; }
        .chart-wrapper { position: relative; height: 280px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table thead { background: var(--bg-primary); }
        .data-table th { padding: 12px; text-align: left; font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; border-bottom: 2px solid var(--border-color); }
        .data-table td { padding: 12px; border-bottom: 1px solid var(--border-color); }
        .data-table tbody tr:hover { background: rgba(96, 165, 250, 0.05); }
        .table-wrapper { max-height: 500px; overflow-y: auto; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .badge.breached { background: rgba(248, 113, 113, 0.2); color: var(--accent-red); }
        .badge.met { background: rgba(52, 211, 153, 0.2); color: var(--accent-green); }
        .health-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; }
        .health-badge.excellent { background: rgba(52, 211, 153, 0.2); color: var(--accent-green); }
        .health-badge.good { background: rgba(96, 165, 250, 0.2); color: var(--accent-blue); }
        .health-badge.warning { background: rgba(251, 191, 36, 0.2); color: var(--accent-yellow); }
        .health-badge.critical { background: rgba(248, 113, 113, 0.2); color: var(--accent-red); }
        .loading { text-align: center; padding: 50px; font-size: 1.2rem; color: var(--accent-blue); }
        .error-message { background: rgba(248, 113, 113, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 18px; margin: 18px 0; color: var(--accent-red); }
        .metric-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .metric-item { background: var(--bg-card); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .metric-item-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px; }
        .metric-item-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-blue); }
        @media (max-width: 1200px) {
            .overview-charts-grid { grid-template-columns: 1fr; }
        }
        @media print {
            body { background: white; color: black; }
            .layout-controls, .filters-section, .tab-container, .upload-section, .header, .widget-btn { display: none !important; }
            .widget-header { cursor: default; }
            .draggable-widget { page-break-inside: avoid; margin-bottom: 20px; border-color: #ccc; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Ticket Analytics Dashboard</h1>
            <div class="subtitle">üé® Drag & Drop ‚Ä¢ Multi-Color Charts ‚Ä¢ Compact Overview</div>
        </div>
        
        <div class="upload-section" id="uploadSection">
            <div style="font-size: 3.5rem; margin-bottom: 15px;">üìÅ</div>
            <label for="fileInput" class="upload-label">Upload Excel File</label>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <div style="color: var(--text-secondary); margin-top: 12px;">Drag & drop or click to upload</div>
            <div id="currentFile"></div>
            <div id="errorMessage"></div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">Processing...</div>
        
        <div class="dashboard-content" id="dashboardContent">
            <div class="filters-section">
                <div class="filters-header">
                    <h3>üîç Filters</h3>
                    <div class="filter-status" id="filterStatusText">Showing all tickets</div>
                </div>
                <div class="filters-grid">
                    <div class="filter-group"><label>FROM DATE</label><input type="date" id="filterDateFrom"></div>
                    <div class="filter-group"><label>TO DATE</label><input type="date" id="filterDateTo"></div>
                    <div class="filter-group"><label>SERVICE</label><select id="filterService"><option value="">All</option></select></div>
                    <div class="filter-group"><label>STATUS</label><select id="filterStatus"><option value="">All</option></select></div>
                    <div class="filter-group"><label>PRIORITY</label><select id="filterPriority"><option value="">All</option></select></div>
                    <div class="filter-group"><label>GROUP</label><select id="filterGroup"><option value="">All</option></select></div>
                    <div class="filter-group"><label>SLA</label><select id="filterSLA"><option value="">All</option></select></div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                    <button class="btn btn-primary" onclick="applyFilters()">Apply</button>
                </div>
            </div>
            
            <div class="tab-container">
                <button class="tab active" onclick="showTab('executive')">üéØ Executive</button>
                <button class="tab" onclick="showTab('overview')">üìä Overview</button>
                <button class="tab" onclick="showTab('services')">üîß Services</button>
                <button class="tab" onclick="showTab('teams')">üë• Teams</button>
                <button class="tab" onclick="showTab('daily')">üìÖ Daily</button>
                <button class="tab" onclick="showTab('monthly')">üìÜ Monthly</button>
                <button class="tab" onclick="showTab('carryover')">üì¶ Carry Over</button>
            </div>
            
            <div id="executive" class="tab-content active">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('executive')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('executive')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="executive-widgets"></div>
            </div>
            
            <div id="overview" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('overview')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('overview')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="overview-widgets"></div>
            </div>
            
            <div id="services" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('services')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('services')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="services-widgets"></div>
            </div>
            
            <div id="teams" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('teams')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('teams')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="teams-widgets"></div>
            </div>
            
            <div id="daily" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('daily')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('daily')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="daily-widgets"></div>
            </div>
            
            <div id="monthly" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('monthly')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('monthly')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="monthly-widgets"></div>
            </div>
            
            <div id="carryover" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('carryover')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('carryover')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="carryover-widgets"></div>
            </div>
        </div>
    </div>
    
    <script>
let chartInstances = {};
let ticketData = null;
let filteredData = null;
let columnMappings = {};

// SLA Lookup Table from IOT SLAs configuration
const SLA_LOOKUP_TABLE = {"priority_defaults":{"Critical":24,"High":48,"Medium":72,"Low":120},"service_priority_rules":{"ECM|Critical":14,"ECM|Medium":48,"ECM|Low":20,"VsaaS|Medium":1,"VsaaS|Low":2,"VsaaS|High":2,"VsaaS|Critical":0.5,"Industrial IoT|Critical":0.5,"Industrial IoT|High":1,"Special Projects|Critical":8,"Special Projects|Medium":48,"Industrial IoT|Medium":72,"Special Projects|High":24,"Special Projects|Low":40,"ECM|High":28},"product_priority_rules":{"Connected Workers|High":72,"Connected Workers|Critical":48,"MOBILE GSM|Medium":1,"MOBILE GSM|Low":2,"MOBILE GSM|High":2,"Assets Tracking|High":12,"Smart City - Smart Parking|High":4,"MOBILE GSM|Critical":0.5,"IoT/AI Processing|High":72,"IoT/AI Processing|Medium":168,"IoT/AI Processing|Critical":24,"Smart District Platform|High":48,"Assets Tracking|Medium":72,"AVAYA|High":6,"AVAYA|Medium":8,"SMART STATION|High":0.5,"Dubai Frame|Low":6,"Al Qana|Critical":0.5,"Smart Metering|Critical":0.5,"Smart Metering|High":1,"Al Ansari Smart Kiosks|Critical":8,"Al Ansari Smart Kiosks|Medium":48,"Al Qana|Medium":24,"Sharjah Safari|Low":120,"Smart Metering|Medium":72,"IoT CONNECTIVITY|High":0.5,"IoT CONNECTIVITY|Low":24,"In Vehicle WiFi|High":72,"In Vehicle WiFi|Medium":96,"IN VEHICLE SURVEILLANCE|Critical":1.17,"MANAGED DI|High":9,"MANAGED DI|Medium":16,"ETISALAT VIDEO CLOUD - APPLICATION|Low":48,"ETISALAT VIDEO CLOUD - APPLICATION|Critical":4,"Digital Signage|Critical":12,"Digital Signage|High":24,"Smart Vehicle Tracking|Medium":72,"Dubai Frame|Critical":1.5,"Smart City - Smart Parking|Critical":2,"Dubai Police FP|Critical":8,"IoT - NB IoT|Low":96,"IN VEHICLE SURVEILLANCE|High":2,"Al Qana|High":24,"MANAGED DI|Low":32,"IN VEHICLE SURVEILLANCE|Medium":12,"IN VEHICLE SURVEILLANCE|Low":24,"VSAAS|Critical":1.25,"MANAGED DPI|Critical":4,"MANAGED DI|Critical":6,"Smart Parking|Low":24,"Digital Payment|Medium":72,"MANAGED DPI|High":8,"Dubai Police FP|High":80,"Smart City - Smart Parking|Medium":16,"Al Ansari Smart Kiosks|High":24,"Al Qana|Low":240,"Dubai Frame|Medium":48,"Digital Payment|High":48,"ETISALAT VIDEO CLOUD - APPLICATION|Medium":24,"Sharjah Safari|Critical":1,"Sharjah Safari|High":4,"Sharjah Safari|Medium":48,"MBRL|High":16,"MBRL|Medium":24,"MBRL|Low":40,"IoT CONNECTIVITY|Critical":0.17,"IoT CONNECTIVITY|Medium":1,"MOHAP|Critical":4,"MOHAP|High":24,"MOHAP|Medium":32,"MOHAP|Low":80,"Dubai Frame|High":6,"SMART STATION|Medium":1,"Smart Parking|High":2,"SMART STATION|Low":2,"Smart Parking|Medium":12,"VSaaS|Critical":4,"VSaaS|Medium":24,"Smart District Platform|Critical":2,"Smart District Platform|Medium":96,"ETISALAT VIDEO CLOUD - APPLICATION|High":8,"MBRL|Critical":8,"Connected Workers|Medium":96,"VSaaS|High":0.5,"Digital Signage|Medium":48,"Connected Workers|Low":8,"Digital Payment|Critical":8,"SMART BUILDING|Critical":0.25,"SMART BUILDING|Medium":72,"CO-Working|High":1,"Secure Vehicle Tracking|High":0.5,"VSaaS|Low":168,"HASSANTUK|Low":24,"HASSANTUK|High":24,"CO-Working|Medium":24,"UTM|Critical":0.08,"UTM|High":4,"Digital Payment|Low":96,"UTM|Low":48,"SMART BUILDING|High":8,"In Vehicle WiFi|Critical":1,"Digital Signage|Low":3,"CO-Working|Critical":0.5,"Secure Vehicle Tracking|Low":5,"Secure Vehicle Tracking|Medium":1,"Secure Vehicle Tracking|Critical":0.17,"UTM|Medium":12,"IoTSync|Medium":48,"Redigized Devices|High":1,"HASSANTUK|Medium":24,"In Vehicle WiFi|Low":48,"Redigized Devices|Critical":6,"Redigized Devices|Medium":480,"Smart District Platform|Low":120,"SMART STATION|Critical":4,"SMART BUILDING|Low":0.17,"HASSANTUK|Critical":0.25}};

Chart.defaults.color = '#94a3b8';
Chart.defaults.font.family = "'Inter', sans-serif";

const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            labels: {
                padding: 12,
                font: { size: 12, weight: '600' }
            }
        }
    }
};

const TAB_WIDGETS = {
    executive: [
        { id: 'service-health', title: 'üèÜ Service Health', type: 'serviceHealth' },
        { id: 'kpis', title: 'üìà KPIs', type: 'kpis' },
        { id: 'aging-chart', title: 'üìä Age Distribution', type: 'chart', chartId: 'agingChart' },
        { id: 'priority-sla', title: 'üìä Priority vs SLA', type: 'chart', chartId: 'prioritySLAChart' },
        { id: 'top-companies', title: 'üìä Top 10 Companies', type: 'chart', chartId: 'topCompaniesChart' }
    ],
    overview: [
        { id: 'overview-grid', title: 'üìä Overview Charts (Compact)', type: 'overviewGrid' }
    ],
    services: [
        { id: 'services-table', title: 'üìã Services Analysis', type: 'servicesTable' },
        { id: 'top-services', title: 'üìä Top Services', type: 'chart', chartId: 'topServicesChart' }
    ],
    teams: [
        { id: 'team-table', title: 'üìã Team Performance', type: 'teamTable' },
        { id: 'top-teams', title: 'üìä Top Teams', type: 'chart', chartId: 'topGroupsChart' }
    ],
    daily: [
        { id: 'daily-table', title: 'üìã Daily (0-7 Days)', type: 'dailyTable' }
    ],
    monthly: [
        { id: 'monthly-table', title: 'üìã Monthly (8-30 Days)', type: 'monthlyTable' }
    ],
    carryover: [
        { id: 'carryover-table', title: 'üìã Carry Over (>30 Days)', type: 'carryoverTable' }
    ]
};

function loadLayout(tabName) {
    const saved = localStorage.getItem(`layout_${tabName}`);
    if (saved) {
        try {
            return JSON.parse(saved);
        } catch (e) {
            console.error('Error loading layout:', e);
        }
    }
    return { order: TAB_WIDGETS[tabName].map(w => w.id), hidden: [] };
}

function saveLayout(tabName, layout) {
    localStorage.setItem(`layout_${tabName}`, JSON.stringify(layout));
}

function resetLayout(tabName) {
    localStorage.removeItem(`layout_${tabName}`);
    renderWidgets(tabName);
    if (filteredData) processData(filteredData);
}

function toggleAllWidgets(tabName) {
    const layout = loadLayout(tabName);
    layout.hidden = layout.hidden.length > 0 ? [] : TAB_WIDGETS[tabName].map(w => w.id);
    saveLayout(tabName, layout);
    renderWidgets(tabName);
}

function toggleWidget(tabName, widgetId) {
    const layout = loadLayout(tabName);
    const index = layout.hidden.indexOf(widgetId);
    
    if (index > -1) {
        layout.hidden.splice(index, 1);
    } else {
        layout.hidden.push(widgetId);
    }
    
    saveLayout(tabName, layout);
    renderWidgets(tabName);
    if (filteredData) processData(filteredData);
}

function renderWidgets(tabName) {
    const container = document.getElementById(`${tabName}-widgets`);
    if (!container) return;
    
    const layout = loadLayout(tabName);
    const widgetsMap = {};
    TAB_WIDGETS[tabName].forEach(w => widgetsMap[w.id] = w);
    
    container.innerHTML = '';
    
    layout.order.forEach(widgetId => {
        const widget = widgetsMap[widgetId];
        if (!widget) return;
        
        const isHidden = layout.hidden.includes(widgetId);
        const widgetDiv = document.createElement('div');
        widgetDiv.className = `draggable-widget${isHidden ? ' hidden' : ''}`;
        widgetDiv.draggable = true;
        widgetDiv.dataset.widgetId = widgetId;
        widgetDiv.dataset.tabName = tabName;
        
        let contentHtml = '';
        
        if (widget.type === 'chart') {
            contentHtml = `<div class="chart-wrapper"><canvas id="${widget.chartId}"></canvas></div>`;
        } else if (widget.type === 'kpis') {
            contentHtml = '<div class="kpi-grid" id="kpiGrid"></div>';
        } else if (widget.type === 'serviceHealth') {
            contentHtml = '<div class="metric-group" id="serviceHealthGrid"></div>';
        } else if (widget.type === 'overviewGrid') {
            contentHtml = `<div class="overview-charts-grid">
                <div class="chart-card"><h3>üìä Status Distribution</h3><div class="chart-wrapper"><canvas id="statusChart"></canvas></div></div>
                <div class="chart-card"><h3>üìä Priority Breakdown</h3><div class="chart-wrapper"><canvas id="priorityChart"></canvas></div></div>
                <div class="chart-card"><h3>üìä SLA Status</h3><div class="chart-wrapper"><canvas id="slaChart"></canvas></div></div>
                <div class="chart-card"><h3>üìä Impact Distribution</h3><div class="chart-wrapper"><canvas id="impactChart"></canvas></div></div>
            </div>`;
        } else if (widget.type === 'servicesTable') {
            contentHtml = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>Service</th><th>Count</th><th>%</th><th>Breach Rate</th><th>Health</th></tr></thead><tbody id="servicesTableBody"></tbody></table></div>';
        } else if (widget.type === 'teamTable') {
            contentHtml = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>Team</th><th>Total</th><th>Breach Rate</th><th>Avg Age</th><th>Performance</th></tr></thead><tbody id="teamPerformanceBody"></tbody></table></div>';
        } else if (widget.type === 'dailyTable') {
            contentHtml = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>Status Reason</th><th>Service</th><th>Breached</th><th>Met</th><th>Total</th></tr></thead><tbody id="dailyTableBody"></tbody></table></div>';
        } else if (widget.type === 'monthlyTable') {
            contentHtml = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>Status Reason</th><th>Service</th><th>Breached</th><th>Met</th><th>Total</th></tr></thead><tbody id="monthlyTableBody"></tbody></table></div>';
        } else if (widget.type === 'carryoverTable') {
            contentHtml = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>Status Reason</th><th>Service</th><th>Breached</th><th>Met</th><th>Total</th></tr></thead><tbody id="carryoverTableBody"></tbody></table></div>';
        }
        
        widgetDiv.innerHTML = `
            <div class="widget-header">
                <div class="widget-title">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <span>${widget.title}</span>
                </div>
                <div class="widget-controls">
                    <button class="widget-btn" onclick="toggleWidget('${tabName}', '${widgetId}')">
                        ${isHidden ? 'Show' : 'Hide'}
                    </button>
                </div>
            </div>
            <div class="widget-content">
                ${contentHtml}
            </div>
        `;
        
        widgetDiv.addEventListener('dragstart', handleDragStart);
        widgetDiv.addEventListener('dragend', handleDragEnd);
        widgetDiv.addEventListener('dragover', handleDragOver);
        widgetDiv.addEventListener('drop', handleDrop);
        widgetDiv.addEventListener('dragenter', handleDragEnter);
        widgetDiv.addEventListener('dragleave', handleDragLeave);
        
        container.appendChild(widgetDiv);
    });
}

let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.draggable-widget').forEach(w => {
        w.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (this !== draggedElement) {
        this.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    
    if (draggedElement !== this && draggedElement.dataset.tabName === this.dataset.tabName) {
        const tabName = this.dataset.tabName;
        const container = document.getElementById(`${tabName}-widgets`);
        const allWidgets = Array.from(container.querySelectorAll('.draggable-widget'));
        const draggedIndex = allWidgets.indexOf(draggedElement);
        const targetIndex = allWidgets.indexOf(this);
        
        if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedElement, this);
        }
        
        const newOrder = Array.from(container.querySelectorAll('.draggable-widget')).map(w => w.dataset.widgetId);
        const layout = loadLayout(tabName);
        layout.order = newOrder;
        saveLayout(tabName, layout);
    }
    
    return false;
}

function initAllTabs() {
    Object.keys(TAB_WIDGETS).forEach(tabName => {
        renderWidgets(tabName);
    });
}

function parseDate(dateValue) {
    if (!dateValue) return null;
    try {
        // If already a valid Date object
        if (dateValue instanceof Date && !isNaN(dateValue)) return dateValue;
        
        const str = String(dateValue).trim();
        if (!str || str === '' || str === 'null' || str === 'undefined') return null;
        
        // Excel serial number (numeric)
        if (!isNaN(dateValue) && typeof dateValue === 'number') {
            const excelEpoch = new Date(1900, 0, 1);
            const msPerDay = 24 * 60 * 60 * 1000;
            return new Date(excelEpoch.getTime() + (dateValue - 2) * msPerDay);
        }
        
        // Try various date formats
        // Format: M/D/YYYY or MM/DD/YYYY or M/D/YYYY H:MM:SS AM/PM
        if (str.includes('/')) {
            const parts = str.split(' ')[0].split('/');
            if (parts.length === 3) {
                const month = parseInt(parts[0], 10);
                const day = parseInt(parts[1], 10);
                let year = parseInt(parts[2], 10);
                
                // Handle 2-digit years
                if (year < 100) {
                    year = year > 50 ? 1900 + year : 2000 + year;
                }
                
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year > 1900) {
                    const result = new Date(year, month - 1, day);
                    if (!isNaN(result.getTime())) {
                        console.log(`‚úÖ Parsed date: ${str} ‚Üí ${result.toISOString()}`);
                        return result;
                    }
                }
            }
        }
        
        // Format: YYYY-MM-DD
        if (str.includes('-') && str.length >= 10) {
            const parts = str.substring(0, 10).split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const day = parseInt(parts[2], 10);
                
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year > 1900) {
                    const result = new Date(year, month - 1, day);
                    if (!isNaN(result.getTime())) {
                        console.log(`‚úÖ Parsed date: ${str} ‚Üí ${result.toISOString()}`);
                        return result;
                    }
                }
            }
        }
        
        // Try native Date parsing as last resort
        const date = new Date(dateValue);
        if (!isNaN(date.getTime()) && date.getFullYear() > 1900) {
            console.log(`‚úÖ Parsed date (native): ${str} ‚Üí ${date.toISOString()}`);
            return date;
        }
        
        console.warn(`‚ö†Ô∏è Could not parse date: ${str}`);
        return null;
    } catch (e) {
        console.error(`‚ùå Error parsing date: ${dateValue}`, e);
        return null;
    }
}

function calcAge(dateValue) {
    const date = parseDate(dateValue);
    if (!date) return 0;
    const now = new Date();
    const diff = now - date;
    const hrs = diff / (1000 * 60 * 60);
    return Math.max(0, hrs);
}

function calcBusinessDays(startDate, endDate) {
    // Optimized business days calculation (fast even for old tickets)
    if (!startDate || !endDate) return 0;
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) return 0;
    
    const millisecondsPerDay = 24 * 60 * 60 * 1000;
    const totalDays = Math.floor((end - start) / millisecondsPerDay);
    
    // Calculate full weeks
    const fullWeeks = Math.floor(totalDays / 7);
    const remainingDays = totalDays % 7;
    
    // Each full week has 5 business days
    let businessDays = fullWeeks * 5;
    
    // Count remaining days
    const startDayOfWeek = start.getDay();
    for (let i = 0; i < remainingDays; i++) {
        const currentDay = (startDayOfWeek + i) % 7;
        // 0 = Sunday, 6 = Saturday
        if (currentDay !== 0 && currentDay !== 6) {
            businessDays++;
        }
    }
    
    return businessDays * 24; // Return hours (business days * 24)
}

function calcBusinessAge(dateValue, resolvedDate) {
    const startDate = parseDate(dateValue);
    if (!startDate) return 0;
    
    // Use resolved date if available, otherwise current date
    const endDate = resolvedDate ? parseDate(resolvedDate) : new Date();
    if (!endDate) return 0;
    
    return calcBusinessDays(startDate, endDate);
}

function getSLA(row) {
    // If we have a calculated SLA status, use it
    if (row._calculatedSLA) {
        return row._calculatedSLA;
    }
    
    // Otherwise, try to read from the Excel column
    if (!columnMappings.slaStatus) return 'Unknown';
    const value = row[columnMappings.slaStatus];
    if (!value || value === '') return 'Unknown';
    return String(value).trim();
}

function calculateSLA(row) {
    // SLA RULES:
    // - Start: Submit Date
    // - Stop: Resolved Date (or current if not resolved)
    // - Pause Statuses: Client Hold, Client Action Required, Pending on client, 
    //   Awaiting Customer, Monitoring Incident, Internal to Etisalat, Future Enhancement
    // - Hours: Business Days Only (exclude weekends)
    
    const ageHours = row._ageToUse; // Age in business hours
    
    // Define pause statuses (case-insensitive matching)
    const pauseStatuses = [
        'client hold',
        'client action required',
        'pending on client',
        'awaiting customer',
        'monitoring incident',
        'internal to etisalat',
        'future enhancement'
    ];
    
    // Step 1: Check if ticket is currently in a pause status
    let isPaused = false;
    if (columnMappings.statusReason && row[columnMappings.statusReason]) {
        const statusReason = String(row[columnMappings.statusReason]).toLowerCase().trim();
        isPaused = pauseStatuses.some(pause => statusReason.includes(pause));
        
        if (isPaused && Math.random() < 0.01) { // Log 1% of paused tickets
            console.log(`‚è∏Ô∏è PAUSED: Status="${row[columnMappings.statusReason]}" ‚Üí SLA MET`);
        }
    }
    
    // Step 2: Check Breach Exception column
    if (columnMappings.breachException && row[columnMappings.breachException]) {
        const exception = String(row[columnMappings.breachException]).toUpperCase();
        if (exception === 'YES') {
            isPaused = true;
            if (Math.random() < 0.01) { // Log 1% of exceptions
                console.log(`‚è∏Ô∏è EXCEPTION: Breach Exception=YES ‚Üí SLA MET`);
            }
        }
    }
    
    // If currently paused, SLA is automatically MET
    if (isPaused) {
        return 'SLA MET';
    }
    
    // Step 3: Determine SLA Target (using IOT rules)
    let slaTarget = null;
    
    // Try to get priority
    let priority = null;
    if (columnMappings.priority && row[columnMappings.priority]) {
        priority = String(row[columnMappings.priority]).trim();
    }
    
    // Method A: Try Product Name + Priority lookup
    if (priority && columnMappings.productName && row[columnMappings.productName]) {
        const productName = String(row[columnMappings.productName]).trim();
        const lookupKey = `${productName}|${priority}`;
        if (SLA_LOOKUP_TABLE.product_priority_rules[lookupKey]) {
            slaTarget = SLA_LOOKUP_TABLE.product_priority_rules[lookupKey];
        }
    }
    
    // Method B: Try Product Tier 3 (Service) + Priority lookup
    if (!slaTarget && priority && columnMappings.productTier3 && row[columnMappings.productTier3]) {
        const productTier3 = String(row[columnMappings.productTier3]).trim();
        const lookupKey = `${productTier3}|${priority}`;
        if (SLA_LOOKUP_TABLE.service_priority_rules[lookupKey]) {
            slaTarget = SLA_LOOKUP_TABLE.service_priority_rules[lookupKey];
        }
    }
    
    // Method C: Use priority default
    if (!slaTarget && priority && SLA_LOOKUP_TABLE.priority_defaults[priority]) {
        slaTarget = SLA_LOOKUP_TABLE.priority_defaults[priority];
    }
    
    // Method D: Use SLA TARGET column from Excel
    if (!slaTarget && columnMappings.slaTarget && row[columnMappings.slaTarget]) {
        const excelTarget = parseFloat(row[columnMappings.slaTarget]);
        if (!isNaN(excelTarget)) {
            slaTarget = excelTarget;
        }
    }
    
    // Method E: Default fallback
    if (!slaTarget) {
        slaTarget = 48; // Default 48 hours
    }
    
    // Debug log for first few tickets
    if (Math.random() < 0.005) { // Log 0.5% of tickets
        console.log(`üéØ SLA Check: Age=${(ageHours/24).toFixed(1)}d, Target=${(slaTarget/24).toFixed(1)}d, Priority=${priority}`);
    }
    
    // Step 4: Compare age vs target
    if (ageHours > slaTarget) {
        return 'SLA BREACHED';
    } else if (ageHours > (slaTarget * 0.75)) {
        return 'AT RISK'; // 75% of SLA consumed
    } else {
        return 'SLA MET';
    }
}

function detectColumns(data) {
    if (!data || data.length === 0) return {};
    const cols = Object.keys(data[0]);
    
    console.log('üîç Detecting columns from Excel...');
    console.log(`üìã Available columns (${cols.length}):`, cols);
    
    function find(patterns) {
        for (let p of patterns) {
            const exact = cols.find(c => c.toLowerCase() === p.toLowerCase());
            if (exact) {
                console.log(`‚úÖ Found exact match: "${exact}" for pattern "${p}"`);
                return exact;
            }
        }
        for (let p of patterns) {
            const found = cols.find(c => {
                const colLower = c.toLowerCase();
                const patternLower = p.toLowerCase();
                return colLower.includes(patternLower) && 
                       !colLower.includes('request') && 
                       !colLower.includes(' id') &&
                       !colLower.includes('_id') &&
                       !colLower.match(/\d{5,}/);
            });
            if (found) {
                console.log(`‚úÖ Found partial match: "${found}" for pattern "${p}"`);
                return found;
            }
        }
        console.warn(`‚ö†Ô∏è No match found for patterns:`, patterns);
        return null;
    }
    
    const mapping = {
        status: find(['status', 'ticket status']),
        priority: find(['priority', 'urgency']),
        service: find(['service', 'service name', 'service type']),
        assignedGroup: find(['service group name', 'service group', 'assigned group', 'group', 'team', 'assignee']),
        impact: find(['impact']),
        slaStatus: find(['sla status', 'slm real time status']),
        slaTarget: find(['sla target']),
        age: find(['age', 'hrs round off', 'ticket age']),
        statusReason: find(['status_reason', 'status reason', 'status_reason_hidden']),
        submitDate: find(['submit date', 'submitted date', 'created date', 'reported date']),
        resolvedDate: find(['resolved date', 'last resolved date', 'resolution date', 'closed date']),
        incidentId: find(['incident id', 'incident number', 'ticket id']),
        company: find(['company', 'company name', 'customer', 'customer name', 'organization', 'org name']),
        breachException: find(['breach exception']),
        productName: find(['product name', 'product']),
        productTier3: find(['product categorization tier 3', 'product cat tier 3'])
    };
    
    console.log('üìä Column mapping result:', mapping);
    
    return mapping;
}

function enrichData(data, mappings) {
    console.log('üíæ Enriching data...');
    console.log(`üìã Total rows to process: ${data.length}`);
    console.log(`üìÖ Submit Date column: ${mappings.submitDate || 'NOT FOUND'}`);
    console.log(`üìÖ Resolved Date column: ${mappings.resolvedDate || 'NOT FOUND'}`);
    console.log(`‚è∞ Age column: ${mappings.age || 'NOT FOUND'}`);
    
    let dateParseSuccessCount = 0;
    let dateParseFailCount = 0;
    let businessDaysUsed = 0;
    
    const enriched = data.map((row, index) => {
        const result = {...row};
        
        if (mappings.submitDate && row[mappings.submitDate]) {
            result._submitDate = parseDate(row[mappings.submitDate]);
            
            if (result._submitDate) {
                dateParseSuccessCount++;
                
                // Get resolved date if available
                const resolvedDate = mappings.resolvedDate && row[mappings.resolvedDate] 
                    ? parseDate(row[mappings.resolvedDate]) 
                    : null;
                
                result._resolvedDate = resolvedDate;
                
                // Calculate age in BUSINESS DAYS (exclude weekends)
                result._calculatedAge = calcBusinessAge(row[mappings.submitDate], resolvedDate);
                result._ageToUse = result._calculatedAge;
                businessDaysUsed++;
                
                // Log first 3 successful parses
                if (dateParseSuccessCount <= 3) {
                    console.log(`‚úÖ Row ${index + 1}: Date parsed successfully`);
                    console.log(`   Submit date: ${result._submitDate.toISOString()}`);
                    if (resolvedDate) {
                        console.log(`   Resolved date: ${resolvedDate.toISOString()}`);
                    }
                    console.log(`   Age (business days): ${result._ageToUse} hours`);
                }
            } else {
                dateParseFailCount++;
                result._ageToUse = 0;
                
                // Log first 3 failures
                if (dateParseFailCount <= 3) {
                    console.warn(`‚ö†Ô∏è Row ${index + 1}: Date parse failed`);
                    console.warn(`   Raw date value: ${row[mappings.submitDate]}`);
                }
            }
        } else if (mappings.age && row[mappings.age]) {
            const existingAge = parseFloat(row[mappings.age]);
            result._ageToUse = !isNaN(existingAge) ? existingAge : 0;
        } else {
            result._ageToUse = 0;
        }
        
        // Calculate SLA status automatically
        result._calculatedSLA = calculateSLA(result);
        
        return result;
    });
    
    console.log(`‚úÖ Date parsing summary:`);
    console.log(`   Success: ${dateParseSuccessCount}/${data.length}`);
    console.log(`   Failed: ${dateParseFailCount}/${data.length}`);
    console.log(`   Using business days: ${businessDaysUsed}/${data.length}`);
    
    // Count SLA statuses
    const slaStatusCount = {};
    enriched.forEach(row => {
        const status = row._calculatedSLA || 'Unknown';
        slaStatusCount[status] = (slaStatusCount[status] || 0) + 1;
    });
    
    console.log(`üìä SLA Status Summary:`);
    Object.keys(slaStatusCount).forEach(status => {
        const count = slaStatusCount[status];
        const percent = ((count / data.length) * 100).toFixed(1);
        console.log(`   ${status}: ${count} (${percent}%)`);
    });
    
    return enriched;
}

function getAge(row) {
    return row._ageToUse || 0;
}

function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
}

const fileInput = document.getElementById('fileInput');
const uploadSection = document.getElementById('uploadSection');
const loading = document.getElementById('loading');
const dashboardContent = document.getElementById('dashboardContent');
const errorMessage = document.getElementById('errorMessage');

fileInput.addEventListener('change', handleFile);

uploadSection.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadSection.classList.add('dragover');
});

uploadSection.addEventListener('dragleave', () => {
    uploadSection.classList.remove('dragover');
});

uploadSection.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadSection.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        handleFile();
    }
});

function handleFile() {
    const file = fileInput.files[0];
    if (!file) return;
    
    if (typeof XLSX === 'undefined') {
        errorMessage.innerHTML = '<div class="error-message">Excel library not loaded</div>';
        return;
    }
    
    document.getElementById('currentFile').innerHTML = `<div class="current-file">‚úÖ ${file.name}</div>`;
    errorMessage.innerHTML = '';
    loading.style.display = 'block';
    dashboardContent.classList.remove('active');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: false, cellNF: false });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            console.log('üìä File loaded:', file.name);
            
            // Check if this is a ROXANNE file with malformed structure
            let rawData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });
            const firstRowKeys = Object.keys(rawData[0] || {});
            const hasEmptyColumns = firstRowKeys.some(k => k.includes('__EMPTY'));
            
            console.log('üìã First attempt - Total rows:', rawData.length);
            console.log('üìë First row keys:', firstRowKeys);
            
            // If we have __EMPTY__ columns, this is a ROXANNE file - use row 2 as headers
            if (hasEmptyColumns || (firstRowKeys.length > 0 && firstRowKeys[0].includes('ROXANNE'))) {
                console.log('üîÑ Detected ROXANNE format - reprocessing with row 2 as headers...');
                
                // Parse without headers first
                const allRows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: false, defval: '' });
                console.log('üìä Raw rows:', allRows.length);
                console.log('üìë Row 1 (title):', allRows[0]);
                console.log('üìë Row 2 (headers):', allRows[1]);
                console.log('üìë Row 3 (first data):', allRows[2]);
                
                if (allRows.length < 3) {
                    throw new Error('ROXANNE file has insufficient rows');
                }
                
                // Row 2 should be the headers
                const headers = allRows[1];
                // Rows 3+ are the data
                const dataRows = allRows.slice(2);
                
                // Convert to objects using row 2 as headers
                rawData = dataRows.map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        if (header && header !== '') {
                            obj[header] = row[index] || '';
                        }
                    });
                    return obj;
                }).filter(obj => Object.keys(obj).length > 0);
                
                console.log('‚úÖ ROXANNE reprocessed - Data rows:', rawData.length);
                console.log('‚úÖ Sample reprocessed row:', rawData[0]);
            }
            
            console.log('üìã Final row count:', rawData.length);
            
            if (rawData.length === 0) throw new Error('No data found in file');
            
            console.log('üîç Detecting columns...');
            columnMappings = detectColumns(rawData);
            console.log('‚úÖ Columns detected:', columnMappings);
            
            console.log('üíæ Enriching data...');
            ticketData = enrichData(rawData, columnMappings);
            filteredData = ticketData;
            
            console.log('‚úÖ Sample enriched row:', filteredData[0]);
            console.log(`üìä Age calculation test - First ticket age: ${filteredData[0]._ageToUse} hours`);
            
            setDefaultDateRange();
            populateFilters();
            initAllTabs();
            processData(filteredData);
            
            loading.style.display = 'none';
            dashboardContent.classList.add('active');
        } catch (error) {
            console.error('‚ùå Error processing file:', error);
            errorMessage.innerHTML = `<div class="error-message">Error: ${error.message}<br>Check browser console (F12) for details</div>`;
            loading.style.display = 'none';
        }
    };
    reader.readAsArrayBuffer(file);
}

function setDefaultDateRange() {
    if (!columnMappings.submitDate) return;
    const dates = ticketData.map(r => r._submitDate).filter(d => d !== null && d !== undefined);
    if (dates.length === 0) return;
    const minDate = new Date(Math.min(...dates));
    const maxDate = new Date(Math.max(...dates));
    document.getElementById('filterDateFrom').value = minDate.toISOString().split('T')[0];
    document.getElementById('filterDateTo').value = maxDate.toISOString().split('T')[0];
}

function populateFilters() {
    const filters = {
        filterService: columnMappings.service,
        filterStatus: columnMappings.status,
        filterPriority: columnMappings.priority,
        filterGroup: columnMappings.assignedGroup,
        filterSLA: columnMappings.slaStatus
    };
    
    Object.entries(filters).forEach(([filterId, columnName]) => {
        const select = document.getElementById(filterId);
        if (!columnName) {
            select.innerHTML = '<option value="">N/A</option>';
            select.disabled = true;
            return;
        }
        select.disabled = false;
        const uniqueValues = [...new Set(ticketData.map(row => {
            const val = row[columnName];
            return val !== null && val !== undefined ? String(val).trim() : '';
        }).filter(v => v !== ''))];
        uniqueValues.sort((a, b) => a.localeCompare(b));
        const placeholder = filterId === 'filterService' ? 'All Services' :
                          filterId === 'filterStatus' ? 'All Statuses' :
                          filterId === 'filterPriority' ? 'All Priorities' :
                          filterId === 'filterGroup' ? 'All Groups' : 'All SLA';
        select.innerHTML = `<option value="">${placeholder}</option>` + 
            uniqueValues.map(value => `<option value="${value}">${value}</option>`).join('');
    });
}

function applyFilters() {
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    
    filteredData = ticketData.filter(row => {
        if (dateFrom || dateTo) {
            const submitDate = row._submitDate;
            if (!submitDate) return false;
            if (dateFrom && submitDate < new Date(dateFrom)) return false;
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59);
                if (submitDate > toDate) return false;
            }
        }
        return (!document.getElementById('filterService').value || String(row[columnMappings.service] || '').trim() === document.getElementById('filterService').value) &&
               (!document.getElementById('filterStatus').value || String(row[columnMappings.status] || '').trim() === document.getElementById('filterStatus').value) &&
               (!document.getElementById('filterPriority').value || String(row[columnMappings.priority] || '').trim() === document.getElementById('filterPriority').value) &&
               (!document.getElementById('filterGroup').value || String(row[columnMappings.assignedGroup] || '').trim() === document.getElementById('filterGroup').value) &&
               (!document.getElementById('filterSLA').value || getSLA(row) === document.getElementById('filterSLA').value);
    });
    
    updateFilterStatus();
    processData(filteredData);
}

function clearFilters() {
    ['filterService', 'filterStatus', 'filterPriority', 'filterGroup', 'filterSLA', 'filterDateFrom', 'filterDateTo'].forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.value = '';
    });
    setDefaultDateRange();
    filteredData = ticketData;
    updateFilterStatus();
    processData(filteredData);
}

function updateFilterStatus() {
    const total = ticketData.length;
    const filtered = filteredData.length;
    document.getElementById('filterStatusText').textContent = 
        filtered === total ? `Showing all ${total.toLocaleString()} tickets` : `Showing ${filtered.toLocaleString()} of ${total.toLocaleString()} tickets`;
}

function generateColorPalette(count) {
    const colors = ['#60a5fa', '#34d399', '#fb923c', '#f87171', '#fbbf24', '#a78bfa', '#38bdf8', '#4ade80', '#facc15', '#c084fc', '#22d3ee', '#86efac', '#fde047', '#e9d5ff', '#bae6fd'];
    return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
}

function processData(data) {
    const countBy = field => {
        if (!field) return {};
        const counts = {};
        data.forEach(row => {
            const val = row[field] !== null && row[field] !== undefined ? String(row[field]).trim() : 'Unknown';
            counts[val] = (counts[val] || 0) + 1;
        });
        return counts;
    };
    
    const slaCounts = {};
    data.forEach(row => {
        const sla = getSLA(row);
        slaCounts[sla] = (slaCounts[sla] || 0) + 1;
    });
    
    const statusCounts = countBy(columnMappings.status);
    const priorityCounts = countBy(columnMappings.priority);
    const impactCounts = countBy(columnMappings.impact);
    const serviceCounts = countBy(columnMappings.service);
    const groupCounts = countBy(columnMappings.assignedGroup);
    const companyCounts = countBy(columnMappings.company);
    
    updateKPIs(data, slaCounts);
    updateServiceHealth(data, serviceCounts);
    updateAgingChart(data);
    updatePrioritySLAChart(data, priorityCounts);
    updateTopCompaniesChart(companyCounts);
    updateChart('statusChart', 'doughnut', Object.keys(statusCounts), Object.values(statusCounts), ['#fb923c', '#60a5fa', '#34d399', '#a78bfa']);
    updateChart('priorityChart', 'pie', Object.keys(priorityCounts), Object.values(priorityCounts), ['#34d399', '#fb923c', '#f87171']);
    updateBarChart('slaChart', Object.keys(slaCounts), Object.values(slaCounts));
    updateChart('impactChart', 'bar', Object.keys(impactCounts), Object.values(impactCounts), ['#60a5fa']);
    updateServicesTable(data, serviceCounts);
    updateTeamPerformance(data, groupCounts);
    updateTopServicesChart(serviceCounts);
    updateTopGroupsChart(groupCounts);
    updateTemporalTables(data);
}

function updateKPIs(data, sla) {
    const total = data.length;
    let breached = 0, met = 0;
    Object.entries(sla).forEach(([s, count]) => {
        const lower = s.toLowerCase();
        if (lower.includes('breach')) breached += count;
        else if (lower.includes('met') || lower.includes('within')) met += count;
    });
    
    const atRisk = data.filter(r => {
        const ageDays = getAge(r) / 24;
        return ageDays >= 3 && ageDays <= 7;
    }).length;
    
    const ages = data.map(r => getAge(r)).filter(a => a > 0);
    const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length / 24) : 0;
    const maxAge = ages.length > 0 ? Math.round(Math.max(...ages) / 24) : 0;
    const aging180 = ages.filter(a => a / 24 > 180).length;
    const over75 = ages.filter(a => a / 24 > 75).length;
    const rate = total > 0 ? ((breached / total) * 100).toFixed(1) : 0;
    
    const kpiGrid = document.getElementById('kpiGrid');
    if (kpiGrid) {
        kpiGrid.innerHTML = `
            <div class="kpi-card"><div class="kpi-label">Total</div><div class="kpi-value">${total.toLocaleString()}</div></div>
            <div class="kpi-card critical"><div class="kpi-label">SLA Breached</div><div class="kpi-value">${breached.toLocaleString()}</div><div class="kpi-subtitle">Rate: ${rate}%</div></div>
            <div class="kpi-card success"><div class="kpi-label">SLA Met</div><div class="kpi-value">${met.toLocaleString()}</div></div>
            <div class="kpi-card warning"><div class="kpi-label">At Risk (3-7d)</div><div class="kpi-value">${atRisk.toLocaleString()}</div></div>
            <div class="kpi-card"><div class="kpi-label">Avg Age</div><div class="kpi-value">${avgAge}</div></div>
            <div class="kpi-card"><div class="kpi-label">Max Age</div><div class="kpi-value">${maxAge}</div></div>
            <div class="kpi-card warning"><div class="kpi-label">>75 Days</div><div class="kpi-value">${over75.toLocaleString()}</div></div>
            <div class="kpi-card critical"><div class="kpi-label">üö® >180 Days</div><div class="kpi-value">${aging180.toLocaleString()}</div></div>
        `;
    }
}

function updateServiceHealth(data, svc) {
    const services = Object.entries(svc).map(([service, count]) => {
        const serviceData = data.filter(r => String(r[columnMappings.service]).trim() === service);
        const breached = serviceData.filter(r => getSLA(r).toLowerCase().includes('breach')).length;
        const rate = (breached / count) * 100;
        
        let health, healthClass, icon;
        if (rate < 10) {
            health = 'Excellent';
            healthClass = 'excellent';
            icon = 'üü¢';
        } else if (rate < 25) {
            health = 'Good';
            healthClass = 'good';
            icon = 'üü°';
        } else if (rate < 50) {
            health = 'Warning';
            healthClass = 'warning';
            icon = 'üü†';
        } else {
            health = 'Critical';
            healthClass = 'critical';
            icon = 'üî¥';
        }
        
        return { service, count, rate: rate.toFixed(1), health, healthClass, icon };
    }).sort((a, b) => b.count - a.count).slice(0, 10);
    
    let html = '';
    services.forEach(s => {
        html += `
            <div class="metric-item">
                <div class="metric-item-label">${s.service}</div>
                <div class="metric-item-value">${s.count.toLocaleString()}</div>
                <div style="margin-top:8px">
                    <span class="health-badge ${s.healthClass}">${s.icon} ${s.health}</span>
                    <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px">Breach: ${s.rate}%</div>
                </div>
            </div>
        `;
    });
    
    const grid = document.getElementById('serviceHealthGrid');
    if (grid) grid.innerHTML = html;
}

function updateAgingChart(data) {
    const ages = data.map(r => getAge(r)).filter(a => a > 0);
    const buckets = {
        '0-7 days': ages.filter(a => a / 24 <= 7).length,
        '8-30 days': ages.filter(a => a / 24 > 7 && a / 24 <= 30).length,
        '31-90 days': ages.filter(a => a / 24 > 30 && a / 24 <= 90).length,
        '91-180 days': ages.filter(a => a / 24 > 90 && a / 24 <= 180).length,
        '180+ days': ages.filter(a => a / 24 > 180).length
    };
    
    destroyChart('agingChart');
    const ctx = document.getElementById('agingChart');
    if (!ctx) return;
    
    chartInstances.agingChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(buckets),
            datasets: [{
                label: 'Tickets',
                data: Object.values(buckets),
                backgroundColor: ['#34d399', '#60a5fa', '#fbbf24', '#fb923c', '#f87171'],
                borderWidth: 0
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                y: { beginAtZero: true, grid: { color: '#334155' } },
                x: { grid: { display: false } }
            }
        }
    });
}

function updatePrioritySLAChart(data, priorityCounts) {
    const priorities = Object.keys(priorityCounts);
    const breached = priorities.map(p => 
        data.filter(r => String(r[columnMappings.priority]).trim() === p && getSLA(r).toLowerCase().includes('breach')).length
    );
    const met = priorities.map(p => 
        data.filter(r => String(r[columnMappings.priority]).trim() === p && (getSLA(r).toLowerCase().includes('met') || getSLA(r).toLowerCase().includes('within'))).length
    );
    
    destroyChart('prioritySLAChart');
    const ctx = document.getElementById('prioritySLAChart');
    if (!ctx) return;
    
    chartInstances.prioritySLAChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: priorities,
            datasets: [
                { label: 'Breached', data: breached, backgroundColor: '#f87171', borderWidth: 0 },
                { label: 'Met', data: met, backgroundColor: '#34d399', borderWidth: 0 }
            ]
        },
        options: {
            ...chartOptions,
            scales: {
                y: { beginAtZero: true, grid: { color: '#334155' } },
                x: { grid: { display: false } }
            }
        }
    });
}

function updateTopCompaniesChart(companyCounts) {
    const top = Object.entries(companyCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const colors = generateColorPalette(top.length);
    
    destroyChart('topCompaniesChart');
    const ctx = document.getElementById('topCompaniesChart');
    if (!ctx) return;
    
    chartInstances.topCompaniesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top.map(c => c[0]),
            datasets: [{
                label: 'Total Tickets',
                data: top.map(c => c[1]),
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            ...chartOptions,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true, grid: { color: '#334155' } },
                y: { grid: { display: false } }
            }
        }
    });
}

function updateServicesTable(data, serviceCounts) {
    const services = Object.entries(serviceCounts).map(([service, count]) => {
        const serviceData = data.filter(r => String(r[columnMappings.service]).trim() === service);
        const breached = serviceData.filter(r => getSLA(r).toLowerCase().includes('breach')).length;
        const rate = (breached / count) * 100;
        
        let healthBadge;
        if (rate < 10) {
            healthBadge = '<span class="health-badge excellent">üü¢ Excellent</span>';
        } else if (rate < 25) {
            healthBadge = '<span class="health-badge good">üü° Good</span>';
        } else if (rate < 50) {
            healthBadge = '<span class="health-badge warning">üü† Warning</span>';
        } else {
            healthBadge = '<span class="health-badge critical">üî¥ Critical</span>';
        }
        
        return {
            service,
            count,
            pct: ((count / data.length) * 100).toFixed(2),
            rate: rate.toFixed(1),
            badge: healthBadge
        };
    }).sort((a, b) => b.count - a.count);
    
    const tbody = document.getElementById('servicesTableBody');
    if (tbody) {
        tbody.innerHTML = services.map(s => `
            <tr>
                <td>${s.service}</td>
                <td style="color:#60a5fa;font-weight:600">${s.count.toLocaleString()}</td>
                <td style="color:#fb923c;font-weight:600">${s.pct}%</td>
                <td style="color:#f87171;font-weight:600">${s.rate}%</td>
                <td>${s.badge}</td>
            </tr>
        `).join('');
    }
}

function updateTeamPerformance(data, groupCounts) {
    const teams = Object.entries(groupCounts).map(([team, count]) => {
        const teamData = data.filter(r => String(r[columnMappings.assignedGroup]).trim() === team);
        const breached = teamData.filter(r => getSLA(r).toLowerCase().includes('breach')).length;
        const rate = (breached / count) * 100;
        const ages = teamData.map(r => getAge(r)).filter(a => a > 0);
        const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length / 24) : 0;
        
        let perfBadge;
        if (rate < 15 && avgAge < 30) {
            perfBadge = '<span class="health-badge excellent">üü¢ Excellent</span>';
        } else if (rate < 30 && avgAge < 60) {
            perfBadge = '<span class="health-badge good">üü° Good</span>';
        } else if (rate < 50) {
            perfBadge = '<span class="health-badge warning">üü† Warning</span>';
        } else {
            perfBadge = '<span class="health-badge critical">üî¥ Needs Improvement</span>';
        }
        
        return { team, count, rate: rate.toFixed(1), avgAge, badge: perfBadge };
    }).sort((a, b) => b.count - a.count);
    
    const tbody = document.getElementById('teamPerformanceBody');
    if (tbody) {
        tbody.innerHTML = teams.map(t => `
            <tr>
                <td>${t.team}</td>
                <td style="color:#60a5fa;font-weight:600">${t.count.toLocaleString()}</td>
                <td style="color:#f87171;font-weight:600">${t.rate}%</td>
                <td style="color:#fb923c;font-weight:600">${t.avgAge}</td>
                <td>${t.badge}</td>
            </tr>
        `).join('');
    }
}

function destroyChart(chartId) {
    if (chartInstances[chartId]) {
        chartInstances[chartId].destroy();
        delete chartInstances[chartId];
    }
}

function updateChart(chartId, type, labels, values, colors) {
    destroyChart(chartId);
    const ctx = document.getElementById(chartId);
    if (!ctx) return;
    
    chartInstances[chartId] = new Chart(ctx, {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: type === 'doughnut' ? { ...chartOptions, cutout: '65%' } : chartOptions
    });
}

function updateBarChart(chartId, labels, values) {
    destroyChart(chartId);
    const ctx = document.getElementById(chartId);
    if (!ctx) return;
    
    const colors = labels.map(l => {
        const lower = l.toLowerCase();
        if (lower.includes('breach')) return '#f87171';
        if (lower.includes('met') || lower.includes('within')) return '#34d399';
        return '#60a5fa';
    });
    
    chartInstances[chartId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tickets',
                data: values,
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                y: { beginAtZero: true, grid: { color: '#334155' } },
                x: { grid: { display: false } }
            }
        }
    });
}

function updateTopServicesChart(serviceCounts) {
    const top = Object.entries(serviceCounts).sort((a, b) => b[1] - a[1]).slice(0, 15);
    const colors = generateColorPalette(top.length);
    
    destroyChart('topServicesChart');
    const ctx = document.getElementById('topServicesChart');
    if (!ctx) return;
    
    chartInstances.topServicesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top.map(s => s[0]),
            datasets: [{
                label: 'Tickets',
                data: top.map(s => s[1]),
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            ...chartOptions,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true, grid: { color: '#334155' } },
                y: { grid: { display: false } }
            }
        }
    });
}

function updateTopGroupsChart(groupCounts) {
    const top = Object.entries(groupCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const colors = generateColorPalette(top.length);
    
    destroyChart('topGroupsChart');
    const ctx = document.getElementById('topGroupsChart');
    if (!ctx) return;
    
    chartInstances.topGroupsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top.map(g => g[0]),
            datasets: [{
                label: 'Tickets',
                data: top.map(g => g[1]),
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            ...chartOptions,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true, grid: { color: '#334155' } },
                y: { grid: { display: false } }
            }
        }
    });
}

function updateTemporalTables(data) {
    const statusReasonCol = columnMappings.statusReason;
    const serviceCol = columnMappings.service;
    
    if (!statusReasonCol || !serviceCol) {
        ['dailyTableBody', 'monthlyTableBody', 'carryoverTableBody'].forEach(id => {
            const elem = document.getElementById(id);
            if (elem) elem.innerHTML = '<tr><td colspan="5">Data not available</td></tr>';
        });
        return;
    }
    
    const daily = data.filter(r => getAge(r) / 24 <= 7);
    const monthly = data.filter(r => {
        const ageDays = getAge(r) / 24;
        return ageDays > 7 && ageDays <= 30;
    });
    const carryover = data.filter(r => getAge(r) / 24 > 30);
    
    function populateTable(tableBodyId, filteredData) {
        const reasons = [...new Set(filteredData.map(r => r[statusReasonCol]))].filter(r => r && r !== 'Unknown');
        let html = '';
        
        reasons.slice(0, 20).forEach(reason => {
            const reasonData = filteredData.filter(r => r[statusReasonCol] === reason);
            const services = [...new Set(reasonData.map(r => r[serviceCol]))].slice(0, 5);
            
            services.forEach(service => {
                const serviceData = reasonData.filter(r => r[serviceCol] === service);
                const breached = serviceData.filter(r => getSLA(r).toLowerCase().includes('breach')).length;
                const met = serviceData.filter(r => {
                    const sla = getSLA(r).toLowerCase();
                    return sla.includes('met') || sla.includes('within');
                }).length;
                
                html += `
                    <tr>
                        <td>${reason}</td>
                        <td>${service}</td>
                        <td><span class="badge breached">${breached}</span></td>
                        <td><span class="badge met">${met}</span></td>
                        <td style="font-weight:600">${serviceData.length}</td>
                    </tr>
                `;
            });
        });
        
        const tbody = document.getElementById(tableBodyId);
        if (tbody) {
            tbody.innerHTML = html || '<tr><td colspan="5">No data</td></tr>';
        }
    }
    
    populateTable('dailyTableBody', daily);
    populateTable('monthlyTableBody', monthly);
    populateTable('carryoverTableBody', carryover);
}
    </script>
</body>
</html>
