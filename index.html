<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #2d3b52;
            --accent-blue: #60a5fa;
            --accent-green: #34d399;
            --accent-red: #f87171;
            --accent-orange: #fb923c;
            --accent-yellow: #fbbf24;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .container { max-width: 1920px; margin: 0 auto; padding: 30px; }
        .header { background: var(--bg-secondary); border-radius: 12px; padding: 35px; margin-bottom: 25px; border: 1px solid var(--border-color); }
        .header h1 { font-size: 2.2rem; font-weight: 700; margin-bottom: 8px; }
        .header .subtitle { font-size: 1rem; color: var(--text-secondary); }
        .upload-section { background: var(--bg-secondary); border: 2px dashed var(--border-color); border-radius: 12px; padding: 45px; margin-bottom: 30px; text-align: center; }
        .upload-section.dragover { border-color: var(--accent-blue); background: rgba(96, 165, 250, 0.05); }
        .upload-label { display: inline-block; padding: 14px 40px; background: var(--accent-blue); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; }
        .upload-label:hover { background: #3b82f6; transform: translateY(-2px); }
        #fileInput { display: none; }
        .current-file { margin-top: 15px; padding: 10px 20px; background: rgba(52, 211, 153, 0.1); border: 1px solid var(--accent-green); border-radius: 8px; display: inline-block; color: var(--accent-green); }
        .filters-section { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 25px; }
        .filters-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filters-header h3 { font-size: 1.2rem; }
        .filter-status { color: var(--accent-blue); font-size: 0.9rem; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; margin-bottom: 18px; }
        .filter-group label { font-size: 0.75rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; display: block; }
        .filter-group select, .filter-group input { width: 100%; padding: 11px 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.95rem; cursor: pointer; }
        .filter-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .btn { padding: 9px 22px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-warning { background: var(--accent-orange); color: white; }
        .btn-icon { display: flex; align-items: center; gap: 8px; }
        .dashboard-content { display: none; }
        .dashboard-content.active { display: block; }
        .layout-controls { display: flex; gap: 10px; justify-content: flex-end; margin-bottom: 20px; flex-wrap: wrap; }
        .widgets-container { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .draggable-widget { background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 12px; overflow: hidden; transition: all 0.3s; }
        .draggable-widget.hidden { display: none; }
        .draggable-widget.dragging { opacity: 0.5; transform: rotate(2deg); border-color: var(--accent-blue); }
        .draggable-widget.drag-over { border-color: var(--accent-green); border-style: dashed; }
        .widget-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; background: linear-gradient(135deg, rgba(96, 165, 250, 0.1) 0%, rgba(52, 211, 153, 0.05) 100%); border-bottom: 1px solid var(--border-color); cursor: move; user-select: none; }
        .widget-header:hover { background: linear-gradient(135deg, rgba(96, 165, 250, 0.15) 0%, rgba(52, 211, 153, 0.08) 100%); }
        .widget-title { display: flex; align-items: center; gap: 12px; font-size: 1.3rem; font-weight: 700; }
        .drag-handle { font-size: 1.2rem; color: var(--text-secondary); cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .widget-controls { display: flex; gap: 10px; }
        .widget-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
        .widget-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); background: rgba(96, 165, 250, 0.1); }
        .widget-content { padding: 25px; }
        .tab-container { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.3s; border-bottom: 3px solid transparent; margin-bottom: -6px; }
        .tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; }
        .kpi-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 24px; transition: all 0.3s; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .kpi-card.critical { border-color: var(--accent-red); background: rgba(248, 113, 113, 0.05); }
        .kpi-card.warning { border-color: var(--accent-orange); }
        .kpi-card.success { border-color: var(--accent-green); }
        .kpi-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; margin-bottom: 10px; }
        .kpi-value { font-family: monospace; font-size: 2.8rem; font-weight: 700; line-height: 1; }
        .kpi-card:nth-child(1) .kpi-value { color: var(--accent-blue); }
        .kpi-card:nth-child(2) .kpi-value { color: var(--accent-red); }
        .kpi-card:nth-child(3) .kpi-value { color: var(--accent-green); }
        .kpi-card:nth-child(4) .kpi-value { color: var(--accent-orange); }
        .kpi-subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; }
        .overview-charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .chart-card { background: var(--bg-card); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .chart-card h3 { margin-bottom: 15px; font-size: 1.1rem; }
        .chart-wrapper { position: relative; height: 280px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table thead { background: var(--bg-primary); }
        .data-table th { padding: 12px; text-align: left; font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; border-bottom: 2px solid var(--border-color); }
        .data-table td { padding: 12px; border-bottom: 1px solid var(--border-color); }
        .data-table tbody tr:hover { background: rgba(96, 165, 250, 0.05); }
        .table-wrapper { max-height: 500px; overflow-y: auto; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .badge.breached { background: rgba(248, 113, 113, 0.2); color: var(--accent-red); }
        .badge.met { background: rgba(52, 211, 153, 0.2); color: var(--accent-green); }
        .health-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; }
        .health-badge.excellent { background: rgba(52, 211, 153, 0.2); color: var(--accent-green); }
        .health-badge.good { background: rgba(96, 165, 250, 0.2); color: var(--accent-blue); }
        .health-badge.warning { background: rgba(251, 191, 36, 0.2); color: var(--accent-yellow); }
        .health-badge.critical { background: rgba(248, 113, 113, 0.2); color: var(--accent-red); }
        .loading { text-align: center; padding: 50px; font-size: 1.2rem; color: var(--accent-blue); }
        .error-message { background: rgba(248, 113, 113, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 18px; margin: 18px 0; color: var(--accent-red); }
        .metric-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .metric-item { background: var(--bg-card); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .metric-item-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px; }
        .metric-item-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-blue); }
        @media (max-width: 1200px) {
            .overview-charts-grid { grid-template-columns: 1fr; }
        }
        @media print {
            body { background: white; color: black; }
            .layout-controls, .filters-section, .tab-container, .upload-section, .header, .widget-btn { display: none !important; }
            .widget-header { cursor: default; }
            .draggable-widget { page-break-inside: avoid; margin-bottom: 20px; border-color: #ccc; }
        }
    /* ‚îÄ‚îÄ DRILL-DOWN MODAL ‚îÄ‚îÄ */
    .drilldown-overlay {
        display: none; position: fixed; inset: 0;
        background: rgba(0,0,0,0.75); z-index: 9999;
        align-items: flex-start; justify-content: center;
        padding: 40px 20px; overflow-y: auto;
    }
    .drilldown-overlay.open { display: flex; }
    .drilldown-modal {
        background: #1a2035; border: 1px solid #334155;
        border-radius: 14px; width: 100%; max-width: 1300px;
        box-shadow: 0 24px 60px rgba(0,0,0,0.6);
        animation: slideUp .2s ease;
    }
    @keyframes slideUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }
    .drilldown-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 18px 24px; border-bottom: 1px solid #334155;
    }
    .drilldown-title { font-size: 1.1rem; font-weight: 600; color: #e2e8f0; }
    .drilldown-subtitle { font-size: 0.8rem; color: #94a3b8; margin-top: 2px; }
    .drilldown-close {
        background: #334155; border: none; color: #e2e8f0;
        width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
        font-size: 1rem; display: flex; align-items: center; justify-content: center;
        transition: background .2s;
    }
    .drilldown-close:hover { background: #ef4444; }
    .drilldown-toolbar {
        padding: 12px 24px; display: flex; gap: 12px; align-items: center;
        border-bottom: 1px solid #1e293b; flex-wrap: wrap;
    }
    .drilldown-search {
        background: #0f172a; border: 1px solid #334155; border-radius: 8px;
        padding: 7px 12px; color: #e2e8f0; font-size: 0.85rem; flex: 1; min-width: 200px;
    }
    .drilldown-search:focus { outline: none; border-color: #60a5fa; }
    .drilldown-export {
        background: #1d4ed8; border: none; color: #fff; padding: 7px 16px;
        border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;
        white-space: nowrap; transition: background .2s;
    }
    .drilldown-export:hover { background: #2563eb; }
    .drilldown-count { font-size: 0.8rem; color: #94a3b8; white-space: nowrap; }
    .drilldown-table-wrap { overflow-x: auto; max-height: 65vh; }
    .drilldown-table {
        width: 100%; border-collapse: collapse; font-size: 0.82rem;
    }
    .drilldown-table th {
        background: #0f172a; color: #94a3b8; font-weight: 600;
        padding: 10px 14px; text-align: left; position: sticky; top: 0;
        border-bottom: 1px solid #334155; white-space: nowrap; cursor: pointer;
        user-select: none;
    }
    .drilldown-table th:hover { color: #60a5fa; }
    .drilldown-table td {
        padding: 9px 14px; border-bottom: 1px solid #1e293b; color: #e2e8f0;
        max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .drilldown-table tr:hover td { background: rgba(96,165,250,0.06); }
    .dd-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .dd-badge.breached { background: rgba(248,113,113,0.2); color: #f87171; }
    .dd-badge.met     { background: rgba(52,211,153,0.2); color: #34d399; }
    .dd-badge.risk    { background: rgba(251,191,36,0.2); color: #fbbf24; }
    .dd-badge.p1 { background: rgba(248,113,113,0.15); color: #f87171; }
    .dd-badge.p2 { background: rgba(251,191,36,0.15); color: #fbbf24; }
    .dd-badge.p3 { background: rgba(96,165,250,0.15); color: #60a5fa; }
    .dd-badge.p4 { background: rgba(148,163,184,0.15); color: #94a3b8; }
    .kpi-card { cursor: pointer; }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(96,165,250,0.2); border-color: #60a5fa !important; }
    .metric-item { cursor: pointer; }
    .metric-item:hover { background: rgba(96,165,250,0.08); border-radius: 8px; }
    </style>
</head>
<body>
<!-- ‚îÄ‚îÄ DRILL-DOWN MODAL ‚îÄ‚îÄ -->
<div class="drilldown-overlay" id="drilldownOverlay" onclick="closeDrilldown(event)">
  <div class="drilldown-modal" onclick="event.stopPropagation()">
    <div class="drilldown-header">
      <div>
        <div class="drilldown-title" id="ddTitle">Ticket Details</div>
        <div class="drilldown-subtitle" id="ddSubtitle"></div>
      </div>
      <button class="drilldown-close" onclick="closeDrilldown()">‚úï</button>
    </div>
    <div class="drilldown-toolbar">
      <input class="drilldown-search" id="ddSearch" placeholder="üîç Search tickets..." oninput="filterDDTable()">
      <span class="drilldown-count" id="ddCount"></span>
      <button class="drilldown-export" onclick="exportDDToCSV()">‚¨á Export CSV</button>
    </div>
    <div class="drilldown-table-wrap">
      <table class="drilldown-table" id="ddTable">
        <thead id="ddThead"></thead>
        <tbody id="ddTbody"></tbody>
      </table>
    </div>
  </div>
</div>
    <div class="container">
        <div class="header">
            <h1>üìä Ticket Analytics Dashboard</h1>
            <div class="subtitle">üé® Drag & Drop ‚Ä¢ Multi-Color Charts ‚Ä¢ Compact Overview</div>
        </div>
        
        <div class="upload-section" id="uploadSection">
            <div style="font-size: 3.5rem; margin-bottom: 15px;">üìÅ</div>
            <label for="fileInput" class="upload-label">Upload Excel File</label>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <div style="color: var(--text-secondary); margin-top: 12px;">Drag & drop or click to upload</div>
            <div id="currentFile"></div>
            <div id="errorMessage"></div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">Processing...</div>
        
        <div class="dashboard-content" id="dashboardContent">
            <div class="filters-section">
                <div class="filters-header">
                    <h3>üîç Filters</h3>
                    <div class="filter-status" id="filterStatusText">Showing all tickets</div>
                </div>
                <div class="filters-grid">
                    <div class="filter-group"><label>FROM DATE</label><input type="date" id="filterDateFrom"></div>
                    <div class="filter-group"><label>TO DATE</label><input type="date" id="filterDateTo"></div>
                    <div class="filter-group"><label>SERVICE</label><select id="filterService"><option value="">All</option></select></div>
                    <div class="filter-group"><label>STATUS</label><select id="filterStatus"><option value="">All</option></select></div>
                    <div class="filter-group"><label>PRIORITY</label><select id="filterPriority"><option value="">All</option></select></div>
                    <div class="filter-group"><label>GROUP</label><select id="filterGroup"><option value="">All</option></select></div>
                    <div class="filter-group"><label>SLA</label><select id="filterSLA"><option value="">All</option></select></div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                    <button class="btn btn-primary" onclick="applyFilters()">Apply</button>
                </div>
            </div>
            
            <div class="tab-container">
                <button class="tab active" onclick="showTab('executive')">üéØ Executive</button>
                <button class="tab" onclick="showTab('overview')">üìä Overview</button>
                <button class="tab" onclick="showTab('services')">üîß Services</button>
                <button class="tab" onclick="showTab('teams')">üë• Teams</button>
                <button class="tab" onclick="showTab('daily')">üìÖ Daily</button>
                <button class="tab" onclick="showTab('monthly')">üìÜ Monthly</button>
                <button class="tab" onclick="showTab('carryover')">üì¶ Carry Over</button>
            </div>
            
            <div id="executive" class="tab-content active">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('executive')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('executive')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="executive-widgets"></div>
            </div>
            
            <div id="overview" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('overview')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('overview')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="overview-widgets"></div>
            </div>
            
            <div id="services" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('services')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('services')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="services-widgets"></div>
            </div>
            
            <div id="teams" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('teams')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('teams')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="teams-widgets"></div>
            </div>
            
            <div id="daily" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('daily')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('daily')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="daily-widgets"></div>
            </div>
            
            <div id="monthly" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('monthly')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('monthly')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="monthly-widgets"></div>
            </div>
            
            <div id="carryover" class="tab-content">
                <div class="layout-controls">
                    <button class="btn btn-secondary btn-icon" onclick="resetLayout('carryover')"><span>üîÑ</span><span>Reset</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleAllWidgets('carryover')"><span>üëÅÔ∏è</span><span>Show/Hide All</span></button>
                </div>
                <div class="widgets-container" id="carryover-widgets"></div>
            </div>
        </div>
    </div>
    
    <script>
let chartInstances = {};
let ticketData = null;
let filteredData = null;
let columnMappings = {};

// IOT SLA Rules (132 rules: 24x7/8x5/9x5)
const IOT_SLA_RULES = {"SVC:ECM|Critical":{"h":14.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SVC:ECM|Medium":{"h":48.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SVC:ECM|Low":{"h":20.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Connected Workers|High":{"h":72.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"Connected Workers|Critical":{"h":48.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"MOBILE GSM|Medium":{"h":1.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SVC:VsaaS|Medium":{"h":1.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MOBILE GSM|Low":{"h":2.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SVC:VsaaS|Low":{"h":2.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MOBILE GSM|High":{"h":2.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SVC:VsaaS|High":{"h":2.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Assets Tracking|High":{"h":12.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart City - Smart Parking|High":{"h":4.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MOBILE GSM|Critical":{"h":0.5,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SVC:VsaaS|Critical":{"h":0.5,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"IoT/AI Processing|High":{"h":72.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"IoT/AI Processing|Medium":{"h":168.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"IoT/AI Processing|Critical":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart District Platform|High":{"h":48.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Assets Tracking|Medium":{"h":72.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"AVAYA|High":{"h":6.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"AVAYA|Medium":{"h":8.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SMART STATION|High":{"h":0.5,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Dubai Frame|Low":{"h":6.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Al Qana|Critical":{"h":0.5,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart Metering|Critical":{"h":0.5,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"SVC:Industrial IoT|Critical":{"h":0.5,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"Smart Metering|High":{"h":1.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"SVC:Industrial IoT|High":{"h":1.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"Al Ansari Smart Kiosks|Critical":{"h":8.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SVC:Special Projects|Critical":{"h":8.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Al Ansari Smart Kiosks|Medium":{"h":48.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SVC:Special Projects|Medium":{"h":48.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Al Qana|Medium":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Sharjah Safari|Low":{"h":120.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart Metering|Medium":{"h":72.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"SVC:Industrial IoT|Medium":{"h":72.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"IoT CONNECTIVITY|High":{"h":0.5,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"IoT CONNECTIVITY|Low":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"In Vehicle WiFi|High":{"h":72.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"In Vehicle WiFi|Medium":{"h":96.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"IN VEHICLE SURVEILLANCE|Critical":{"h":1.1667,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MANAGED DI|High":{"h":9.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MANAGED DI|Medium":{"h":16.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"ETISALAT VIDEO CLOUD - APPLICATION|Low":{"h":48.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"ETISALAT VIDEO CLOUD - APPLICATION|Critical":{"h":4.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Digital Signage|Critical":{"h":12.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Digital Signage|High":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart Vehicle Tracking|Medium":{"h":72.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Dubai Frame|Critical":{"h":1.5,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart City - Smart Parking|Critical":{"h":2.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Dubai Police FP|Critical":{"h":8.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"IoT - NB IoT|Low":{"h":96.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"IN VEHICLE SURVEILLANCE|High":{"h":2.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Al Qana|High":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MANAGED DI|Low":{"h":32.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"IN VEHICLE SURVEILLANCE|Medium":{"h":12.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"IN VEHICLE SURVEILLANCE|Low":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"VSAAS|Critical":{"h":1.25,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MANAGED DPI|Critical":{"h":4.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MANAGED DI|Critical":{"h":6.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart Parking|Low":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Digital Payment|Medium":{"h":72.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MANAGED DPI|High":{"h":8.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Dubai Police FP|High":{"h":80.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"Smart City - Smart Parking|Medium":{"h":16.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Al Ansari Smart Kiosks|High":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SVC:Special Projects|High":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Al Qana|Low":{"h":240.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Dubai Frame|Medium":{"h":48.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Digital Payment|High":{"h":48.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"ETISALAT VIDEO CLOUD - APPLICATION|Medium":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Sharjah Safari|Critical":{"h":1.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Sharjah Safari|High":{"h":4.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Sharjah Safari|Medium":{"h":48.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MBRL|High":{"h":16.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"MBRL|Medium":{"h":24.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"MBRL|Low":{"h":40.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"SVC:Special Projects|Low":{"h":40.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"IoT CONNECTIVITY|Critical":{"h":0.1667,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"IoT CONNECTIVITY|Medium":{"h":1.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MOHAP|Critical":{"h":4.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"MOHAP|High":{"h":24.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"MOHAP|Medium":{"h":32.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"MOHAP|Low":{"h":80.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"SVC:ECM|High":{"h":28.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Dubai Frame|High":{"h":6.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SMART STATION|Medium":{"h":1.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart Parking|High":{"h":2.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SMART STATION|Low":{"h":2.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart Parking|Medium":{"h":12.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"VSaaS|Critical":{"h":4.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"VSaaS|Medium":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart District Platform|Critical":{"h":2.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart District Platform|Medium":{"h":96.0,"tag":"ETISALAT 9*5","s":"9x5","hpd":9,"es":true,"eu":true},"ETISALAT VIDEO CLOUD - APPLICATION|High":{"h":8.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"MBRL|Critical":{"h":8.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"Connected Workers|Medium":{"h":96.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"VSaaS|High":{"h":0.5,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Digital Signage|Medium":{"h":48.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"Connected Workers|Low":{"h":8.0,"tag":"ETISALAT 9*5","s":"9x5","hpd":9,"es":true,"eu":true},"Digital Payment|Critical":{"h":8.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SMART BUILDING|Critical":{"h":0.25,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SMART BUILDING|Medium":{"h":72.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"CO-Working|High":{"h":1.0,"tag":"ETISALAT 9*5","s":"9x5","hpd":9,"es":true,"eu":true},"Secure Vehicle Tracking|High":{"h":0.5,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"VSaaS|Low":{"h":168.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"HASSANTUK|Low":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"HASSANTUK|High":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"CO-Working|Medium":{"h":24.0,"tag":"ETISALAT 9*5","s":"9x5","hpd":9,"es":true,"eu":true},"UTM|Critical":{"h":0.0833,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"UTM|High":{"h":4.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Digital Payment|Low":{"h":96.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"UTM|Low":{"h":48.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SMART BUILDING|High":{"h":8.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"In Vehicle WiFi|Critical":{"h":1.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Digital Signage|Low":{"h":3.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"CO-Working|Critical":{"h":0.5,"tag":"ETISALAT 9*5","s":"9x5","hpd":9,"es":true,"eu":true},"Secure Vehicle Tracking|Low":{"h":5.0,"tag":"ETISALAT 9*5","s":"9x5","hpd":9,"es":true,"eu":true},"Secure Vehicle Tracking|Medium":{"h":1.0,"tag":"ETISALAT 9*5","s":"9x5","hpd":9,"es":true,"eu":true},"Secure Vehicle Tracking|Critical":{"h":0.1667,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"UTM|Medium":{"h":12.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"IoTSync|Medium":{"h":48.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Redigized Devices|High":{"h":1.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"HASSANTUK|Medium":{"h":24.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"In Vehicle WiFi|Low":{"h":48.0,"tag":"Public Cloud 8*5","s":"8x5","hpd":8,"es":true,"eu":true},"Redigized Devices|Critical":{"h":6.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Redigized Devices|Medium":{"h":480.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"Smart District Platform|Low":{"h":120.0,"tag":"ETISALAT 9*5","s":"9x5","hpd":9,"es":true,"eu":true},"SMART STATION|Critical":{"h":4.0,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false},"SMART BUILDING|Low":{"h":0.1667,"tag":"ETISALAT 9*5","s":"9x5","hpd":9,"es":true,"eu":true},"HASSANTUK|Critical":{"h":0.25,"tag":"Etisalat - 24*7","s":"24x7","hpd":24,"es":false,"eu":false}};
const PRIORITY_DEFAULTS = {Critical:{h:24,s:'24x7',hpd:24,es:false,eu:false},High:{h:48,s:'24x7',hpd:24,es:false,eu:false},Medium:{h:72,s:'24x7',hpd:24,es:false,eu:false},Low:{h:120,s:'24x7',hpd:24,es:false,eu:false}};

Chart.defaults.color = '#94a3b8';
Chart.defaults.font.family = "'Inter', sans-serif";

const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            labels: {
                padding: 12,
                font: { size: 12, weight: '600' }
            }
        }
    }
};

const TAB_WIDGETS = {
    executive: [
        { id: 'service-health', title: 'üèÜ Service Health', type: 'serviceHealth' },
        { id: 'kpis', title: 'üìà KPIs', type: 'kpis' },
        { id: 'aging-chart', title: 'üìä Age Distribution', type: 'chart', chartId: 'agingChart' },
        { id: 'priority-sla', title: 'üìä Priority vs SLA', type: 'chart', chartId: 'prioritySLAChart' },
        { id: 'top-companies', title: 'üìä Top 10 Companies', type: 'chart', chartId: 'topCompaniesChart' }
    ],
    overview: [
        { id: 'overview-grid', title: 'üìä Overview Charts (Compact)', type: 'overviewGrid' }
    ],
    services: [
        { id: 'services-table', title: 'üìã Services Analysis', type: 'servicesTable' },
        { id: 'top-services', title: 'üìä Top Services', type: 'chart', chartId: 'topServicesChart' }
    ],
    teams: [
        { id: 'team-table', title: 'üìã Team Performance', type: 'teamTable' },
        { id: 'top-teams', title: 'üìä Top Teams', type: 'chart', chartId: 'topGroupsChart' }
    ],
    daily: [
        { id: 'daily-table', title: 'üìã Daily (0-7 Days)', type: 'dailyTable' }
    ],
    monthly: [
        { id: 'monthly-table', title: 'üìã Monthly (8-30 Days)', type: 'monthlyTable' }
    ],
    carryover: [
        { id: 'carryover-table', title: 'üìã Carry Over (>30 Days)', type: 'carryoverTable' }
    ]
};

function loadLayout(tabName) {
    const saved = localStorage.getItem(`layout_${tabName}`);
    if (saved) {
        try {
            return JSON.parse(saved);
        } catch (e) {
            console.error('Error loading layout:', e);
        }
    }
    return { order: TAB_WIDGETS[tabName].map(w => w.id), hidden: [] };
}

function saveLayout(tabName, layout) {
    localStorage.setItem(`layout_${tabName}`, JSON.stringify(layout));
}

function resetLayout(tabName) {
    localStorage.removeItem(`layout_${tabName}`);
    renderWidgets(tabName);
    if (filteredData) processData(filteredData);
}

function toggleAllWidgets(tabName) {
    const layout = loadLayout(tabName);
    layout.hidden = layout.hidden.length > 0 ? [] : TAB_WIDGETS[tabName].map(w => w.id);
    saveLayout(tabName, layout);
    renderWidgets(tabName);
}

function toggleWidget(tabName, widgetId) {
    const layout = loadLayout(tabName);
    const index = layout.hidden.indexOf(widgetId);
    
    if (index > -1) {
        layout.hidden.splice(index, 1);
    } else {
        layout.hidden.push(widgetId);
    }
    
    saveLayout(tabName, layout);
    renderWidgets(tabName);
    if (filteredData) processData(filteredData);
}

function renderWidgets(tabName) {
    const container = document.getElementById(`${tabName}-widgets`);
    if (!container) return;
    
    const layout = loadLayout(tabName);
    const widgetsMap = {};
    TAB_WIDGETS[tabName].forEach(w => widgetsMap[w.id] = w);
    
    container.innerHTML = '';
    
    layout.order.forEach(widgetId => {
        const widget = widgetsMap[widgetId];
        if (!widget) return;
        
        const isHidden = layout.hidden.includes(widgetId);
        const widgetDiv = document.createElement('div');
        widgetDiv.className = `draggable-widget${isHidden ? ' hidden' : ''}`;
        widgetDiv.draggable = true;
        widgetDiv.dataset.widgetId = widgetId;
        widgetDiv.dataset.tabName = tabName;
        
        let contentHtml = '';
        
        if (widget.type === 'chart') {
            contentHtml = `<div class="chart-wrapper"><canvas id="${widget.chartId}"></canvas></div>`;
        } else if (widget.type === 'kpis') {
            contentHtml = '<div class="kpi-grid" id="kpiGrid"></div>';
        } else if (widget.type === 'serviceHealth') {
            contentHtml = '<div class="metric-group" id="serviceHealthGrid"></div>';
        } else if (widget.type === 'overviewGrid') {
            contentHtml = `<div class="overview-charts-grid">
                <div class="chart-card"><h3>üìä Status Distribution</h3><div class="chart-wrapper"><canvas id="statusChart"></canvas></div></div>
                <div class="chart-card"><h3>üìä Priority Breakdown</h3><div class="chart-wrapper"><canvas id="priorityChart"></canvas></div></div>
                <div class="chart-card"><h3>üìä SLA Status</h3><div class="chart-wrapper"><canvas id="slaChart"></canvas></div></div>
                <div class="chart-card"><h3>üìä Impact Distribution</h3><div class="chart-wrapper"><canvas id="impactChart"></canvas></div></div>
            </div>`;
        } else if (widget.type === 'servicesTable') {
            contentHtml = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>Service</th><th>Count</th><th>%</th><th>Breach Rate</th><th>Health</th></tr></thead><tbody id="servicesTableBody"></tbody></table></div>';
        } else if (widget.type === 'teamTable') {
            contentHtml = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>Team</th><th>Total</th><th>Breach Rate</th><th>Avg Age</th><th>Performance</th></tr></thead><tbody id="teamPerformanceBody"></tbody></table></div>';
        } else if (widget.type === 'dailyTable') {
            contentHtml = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>Status Reason</th><th>Service</th><th>Breached</th><th>Met</th><th>Total</th></tr></thead><tbody id="dailyTableBody"></tbody></table></div>';
        } else if (widget.type === 'monthlyTable') {
            contentHtml = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>Status Reason</th><th>Service</th><th>Breached</th><th>Met</th><th>Total</th></tr></thead><tbody id="monthlyTableBody"></tbody></table></div>';
        } else if (widget.type === 'carryoverTable') {
            contentHtml = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>Status Reason</th><th>Service</th><th>Breached</th><th>Met</th><th>Total</th></tr></thead><tbody id="carryoverTableBody"></tbody></table></div>';
        }
        
        widgetDiv.innerHTML = `
            <div class="widget-header">
                <div class="widget-title">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <span>${widget.title}</span>
                </div>
                <div class="widget-controls">
                    <button class="widget-btn" onclick="toggleWidget('${tabName}', '${widgetId}')">
                        ${isHidden ? 'Show' : 'Hide'}
                    </button>
                </div>
            </div>
            <div class="widget-content">
                ${contentHtml}
            </div>
        `;
        
        widgetDiv.addEventListener('dragstart', handleDragStart);
        widgetDiv.addEventListener('dragend', handleDragEnd);
        widgetDiv.addEventListener('dragover', handleDragOver);
        widgetDiv.addEventListener('drop', handleDrop);
        widgetDiv.addEventListener('dragenter', handleDragEnter);
        widgetDiv.addEventListener('dragleave', handleDragLeave);
        
        container.appendChild(widgetDiv);
    });
}

let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.draggable-widget').forEach(w => {
        w.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (this !== draggedElement) {
        this.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    
    if (draggedElement !== this && draggedElement.dataset.tabName === this.dataset.tabName) {
        const tabName = this.dataset.tabName;
        const container = document.getElementById(`${tabName}-widgets`);
        const allWidgets = Array.from(container.querySelectorAll('.draggable-widget'));
        const draggedIndex = allWidgets.indexOf(draggedElement);
        const targetIndex = allWidgets.indexOf(this);
        
        if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedElement, this);
        }
        
        const newOrder = Array.from(container.querySelectorAll('.draggable-widget')).map(w => w.dataset.widgetId);
        const layout = loadLayout(tabName);
        layout.order = newOrder;
        saveLayout(tabName, layout);
    }
    
    return false;
}

function initAllTabs() {
    Object.keys(TAB_WIDGETS).forEach(tabName => {
        renderWidgets(tabName);
    });
}

function parseDate(dateValue) {
    if (!dateValue) return null;
    try {
        // If already a valid Date object
        if (dateValue instanceof Date && !isNaN(dateValue)) return dateValue;
        
        const str = String(dateValue).trim();
        if (!str || str === '' || str === 'null' || str === 'undefined') return null;
        
        // Excel serial number (numeric)
        if (!isNaN(dateValue) && typeof dateValue === 'number') {
            const excelEpoch = new Date(1900, 0, 1);
            const msPerDay = 24 * 60 * 60 * 1000;
            return new Date(excelEpoch.getTime() + (dateValue - 2) * msPerDay);
        }
        
        // Try various date formats
        // Format: M/D/YYYY or MM/DD/YYYY or M/D/YYYY H:MM:SS AM/PM
        if (str.includes('/')) {
            const parts = str.split(' ')[0].split('/');
            if (parts.length === 3) {
                const month = parseInt(parts[0], 10);
                const day = parseInt(parts[1], 10);
                let year = parseInt(parts[2], 10);
                
                // Handle 2-digit years
                if (year < 100) {
                    year = year > 50 ? 1900 + year : 2000 + year;
                }
                
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year > 1900) {
                    const result = new Date(year, month - 1, day);
                    if (!isNaN(result.getTime())) {
                        console.log(`‚úÖ Parsed date: ${str} ‚Üí ${result.toISOString()}`);
                        return result;
                    }
                }
            }
        }
        
        // Format: YYYY-MM-DD
        if (str.includes('-') && str.length >= 10) {
            const parts = str.substring(0, 10).split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const day = parseInt(parts[2], 10);
                
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year > 1900) {
                    const result = new Date(year, month - 1, day);
                    if (!isNaN(result.getTime())) {
                        console.log(`‚úÖ Parsed date: ${str} ‚Üí ${result.toISOString()}`);
                        return result;
                    }
                }
            }
        }
        
        // Try native Date parsing as last resort
        const date = new Date(dateValue);
        if (!isNaN(date.getTime()) && date.getFullYear() > 1900) {
            console.log(`‚úÖ Parsed date (native): ${str} ‚Üí ${date.toISOString()}`);
            return date;
        }
        
        console.warn(`‚ö†Ô∏è Could not parse date: ${str}`);
        return null;
    } catch (e) {
        console.error(`‚ùå Error parsing date: ${dateValue}`, e);
        return null;
    }
}


function getSLARule(product, svc, pri) {
    if (pri) {
        if (product) { const r=IOT_SLA_RULES[product+'|'+pri]; if(r) return r; }
        if (svc)     { const r=IOT_SLA_RULES['SVC:'+svc+'|'+pri]; if(r) return r; }
        const d=PRIORITY_DEFAULTS[pri]; if(d) return d;
    }
    return {h:48,s:'24x7',hpd:24,es:false,eu:false};
}

function calcScheduleAge(start, end, hpd, es, eu) {
    if (!start || !end || start >= end) return 0;
    if (!es && !eu && hpd === 24) return Math.max(0,(end-start)/3600000);
    const MS_DAY = 86400000;
    const totalDays = Math.floor((end-start)/MS_DAY);
    const fullWeeks = Math.floor(totalDays/7);
    const rem = totalDays % 7;
    const wpw = 7 - (es?1:0) - (eu?1:0);
    let bdays = fullWeeks * wpw;
    const sd = start.getDay();
    for (let i=0;i<rem;i++) {
        const d=(sd+i)%7;
        if (eu && d===0) continue;
        if (es && d===6) continue;
        bdays++;
    }
    return bdays * hpd;
}

function detectHoldUnit(data, col) {
    if (!col) return 'minutes';
    let vals=[];
    for (let i=0;i<Math.min(50,data.length);i++) { const v=parseFloat(data[i][col]); if(!isNaN(v)&&v>0) vals.push(v); }
    if (!vals.length) return 'minutes';
    return (vals.reduce((a,b)=>a+b,0)/vals.length/60 > 720) ? 'seconds' : 'minutes';
}

function enrichData(data, mappings) {
    console.log(`üíæ enrichData: ${data.length} rows | submit=${mappings.submitDate||'?'} | resolved=${mappings.resolvedDate||'?'} | hold=${mappings.totalTimeOnHold||'none'}`);
    const holdUnit = detectHoldUnit(data, mappings.totalTimeOnHold);
    let ok=0,fail=0,holdApplied=0;

    const enriched = data.map((row,idx) => {
        const result = {...row};
        const pri  = mappings.priority     ? String(row[mappings.priority]     ||'').trim() : '';
        const prod = mappings.productName  ? String(row[mappings.productName]  ||'').trim() : '';
        const svc  = mappings.productTier3 ? String(row[mappings.productTier3] ||'').trim() : '';
        const rule = getSLARule(prod||null, svc||null, pri||null);
        result._slaH = rule.h;
        result._slaS = rule.s;

        if (mappings.submitDate && row[mappings.submitDate]) {
            const sd = parseDate(row[mappings.submitDate]);
            if (sd) {
                ok++;
                const rd = mappings.resolvedDate && row[mappings.resolvedDate] ? parseDate(row[mappings.resolvedDate]) : null;
                result._submitDate = sd; result._resolvedDate = rd;
                const rawAge = calcScheduleAge(sd, rd||new Date(), rule.hpd, rule.es, rule.eu);
                let holdHrs=0;
                if (mappings.totalTimeOnHold && row[mappings.totalTimeOnHold]) {
                    const hv=parseFloat(row[mappings.totalTimeOnHold]);
                    if (!isNaN(hv)&&hv>0) { holdHrs=holdUnit==='seconds'?hv/3600:hv/60; holdApplied++; }
                }
                result._rawAge=rawAge; result._holdHrs=holdHrs;
                result._ageToUse=Math.max(0,rawAge-holdHrs);
                if (ok<=3) console.log(`‚úÖ R${idx+1}: "${prod}"|"${pri}" ‚Üí ${rule.s}(${rule.hpd}h/d es=${rule.es} eu=${rule.eu}) rawAge=${(rawAge/24).toFixed(1)}d hold=${(holdHrs/24).toFixed(1)}d net=${(result._ageToUse/24).toFixed(1)}d target=${rule.h}h`);
            } else { fail++; result._ageToUse=0; if(fail<=3) console.warn(`‚ö†Ô∏è R${idx+1}: bad date "${row[mappings.submitDate]}"`); }
        } else if (mappings.age && row[mappings.age]) {
            result._ageToUse=Math.max(0,parseFloat(row[mappings.age])||0);
        } else { result._ageToUse=0; }

        result._calculatedSLA = calculateSLA(result);
        return result;
    });

    const dist={};
    enriched.forEach(r=>{const s=r._calculatedSLA||'?'; dist[s]=(dist[s]||0)+1;});
    console.log(`\n‚úÖ parsed=${ok} fail=${fail} hold=${holdApplied}`);
    console.log('üìä SLA:', Object.entries(dist).map(([k,v])=>`${k}:${v}(${((v/data.length)*100).toFixed(1)}%)`).join(' | '));
    return enriched;
}

function calculateSLA(row) {
    const PAUSE=['client hold','client action required','pending on client',
                 'awaiting customer','monitoring incident','internal to etisalat','future enhancement'];
    if (columnMappings.statusReason && row[columnMappings.statusReason]) {
        const sr=String(row[columnMappings.statusReason]).toLowerCase();
        if (PAUSE.some(p=>sr.includes(p))) return 'SLA MET';
    }
    if (columnMappings.breachException && row[columnMappings.breachException]) {
        if (String(row[columnMappings.breachException]).toUpperCase()==='YES') return 'SLA MET';
    }
    const age=row._ageToUse||0, target=row._slaH||48;
    if (age>target)        return 'SLA BREACHED';
    if (age>target*0.75)   return 'AT RISK';
    return 'SLA MET';
}

function detectColumns(data) {
    if (!data || data.length === 0) return {};
    const cols = Object.keys(data[0]);
    
    console.log('üîç Detecting columns from Excel...');
    console.log(`üìã Available columns (${cols.length}):`, cols);
    
    function find(patterns) {
        for (let p of patterns) {
            const exact = cols.find(c => c.toLowerCase() === p.toLowerCase());
            if (exact) {
                console.log(`‚úÖ Found exact match: "${exact}" for pattern "${p}"`);
                return exact;
            }
        }
        for (let p of patterns) {
            const found = cols.find(c => {
                const colLower = c.toLowerCase();
                const patternLower = p.toLowerCase();
                return colLower.includes(patternLower) && 
                       !colLower.includes('request') && 
                       !colLower.includes(' id') &&
                       !colLower.includes('_id') &&
                       !colLower.match(/\d{5,}/);
            });
            if (found) {
                console.log(`‚úÖ Found partial match: "${found}" for pattern "${p}"`);
                return found;
            }
        }
        console.warn(`‚ö†Ô∏è No match found for patterns:`, patterns);
        return null;
    }
    
    const mapping = {
        status: find(['status', 'ticket status']),
        priority: find(['priority', 'urgency']),
        service: find(['service', 'service name', 'service type']),
        assignedGroup: find(['service group name', 'service group', 'assigned group', 'group', 'team', 'assignee']),
        impact: find(['impact']),
        slaStatus: find(['sla status', 'slm real time status']),
        slaTarget: find(['sla target']),
        age: find(['age', 'hrs round off', 'ticket age']),
        statusReason: find(['status_reason', 'status reason', 'status_reason_hidden']),
        submitDate: find(['submit date', 'submitted date', 'created date', 'reported date']),
        resolvedDate: find(['resolved date', 'last resolved date', 'resolution date', 'closed date']),
        incidentId: find(['incident id', 'incident number', 'ticket id']),
        company: find(['company', 'company name', 'customer', 'customer name', 'organization', 'org name']),
        breachException: find(['breach exception']),
        productName: find(['product name', 'product']),
        productTier3: find(['product categorization tier 3', 'product cat tier 3']),
        totalTimeOnHold: find(['total time on hold', 'time on hold', 'hold time', 'to_pendingtime'])
    };
    
    console.log('üìä Column mapping result:', mapping);
    
    return mapping;
}

function detectHoldTimeUnit(data, mappings) {
    // Auto-detect if Total Time On Hold is in minutes or seconds
    // by comparing sample values against realistic hold durations
    if (!mappings.totalTimeOnHold) return 'minutes'; // default
    
    let sampleValues = [];
    for (let i = 0; i < Math.min(50, data.length); i++) {
        const val = parseFloat(data[i][mappings.totalTimeOnHold]);
        if (!isNaN(val) && val > 0) sampleValues.push(val);
    }
    
    if (sampleValues.length === 0) return 'minutes';
    
    const avgVal = sampleValues.reduce((a, b) => a + b, 0) / sampleValues.length;
    
    // If avg value in minutes gives > 200 days average hold, likely seconds
    // If avg value in seconds gives < 1 minute hold, likely minutes
    const avgAsMinutes = avgVal / 60; // hours
    const avgAsSeconds = avgVal / 3600; // hours
    
    // Heuristic: if avg as minutes > 720 hours (30 days), it's probably seconds
    if (avgAsMinutes > 720) {
        console.log(`üïê Hold time unit: SECONDS (avg ${avgAsSeconds.toFixed(1)} hours as seconds)`);
        return 'seconds';
    }
    
    console.log(`üïê Hold time unit: MINUTES (avg ${avgAsMinutes.toFixed(1)} hours as minutes)`);
    return 'minutes';
}


function getAge(row) {
    return row._ageToUse || 0;
}

function getSLA(row) {
    return row._calculatedSLA || calculateSLA(row);
}

// ‚îÄ‚îÄ DRILL-DOWN ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let _ddRows = [];      // current filtered rows
let _ddAllRows = [];   // all rows for the current drill-down
let _ddSort = { col: null, asc: true };

// Key columns to show (auto-detected at render time)
const DD_COLS_PRIORITY = [
    { key: '_incidentId',  label: 'Incident ID'   },
    { key: '_priority',    label: 'Priority'       },
    { key: '_service',     label: 'Service'        },
    { key: '_status',      label: 'Status'         },
    { key: '_statusReason',label: 'Status Reason'  },
    { key: '_submitDate',  label: 'Submit Date',   isDate: true },
    { key: '_ageToUse',    label: 'Net Age (hrs)'  },
    { key: '_slaH',        label: 'SLA Target (h)' },
    { key: '_calculatedSLA', label: 'SLA Status'   },
    { key: '_schedule',    label: 'Schedule'       },
];

function openDrilldown(rows, title, subtitle) {
    _ddAllRows = rows;
    _ddRows    = rows;
    document.getElementById('ddTitle').textContent    = title;
    document.getElementById('ddSubtitle').textContent = subtitle || `${rows.length.toLocaleString()} tickets`;
    document.getElementById('ddSearch').value = '';
    _ddSort = { col: null, asc: true };
    renderDDTable(_ddRows);
    document.getElementById('drilldownOverlay').classList.add('open');
    document.body.style.overflow = 'hidden';
}

function closeDrilldown(e) {
    if (e && e.target !== document.getElementById('drilldownOverlay')) return;
    document.getElementById('drilldownOverlay').classList.remove('open');
    document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') { document.getElementById('drilldownOverlay').classList.remove('open'); document.body.style.overflow=''; }});

function renderDDTable(rows) {
    document.getElementById('ddCount').textContent = `${rows.length.toLocaleString()} tickets`;

    // Build display columns from actual data
    const cols = buildDDCols(rows);

    // Header
    const thead = document.getElementById('ddThead');
    thead.innerHTML = '<tr>' + cols.map((c,i) =>
        `<th onclick="sortDDTable(${i})" title="Sort by ${c.label}">${c.label} <span style="color:#60a5fa;font-size:0.7rem">${_ddSort.col===i ? (_ddSort.asc?'‚ñ≤':'‚ñº') : '‚áÖ'}</span></th>`
    ).join('') + '</tr>';

    // Body (cap at 2000 rows for performance)
    const visible = rows.slice(0, 2000);
    const tbody = document.getElementById('ddTbody');
    tbody.innerHTML = visible.map(row => {
        const cells = cols.map(c => {
            let val = getCellVal(row, c);
            return `<td title="${String(val).replace(/"/g,'&quot;')}">${formatDDCell(val, c)}</td>`;
        }).join('');
        return `<tr>${cells}</tr>`;
    }).join('');

    if (rows.length > 2000) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="${cols.length}" style="text-align:center;padding:12px;color:#94a3b8">Showing first 2,000 of ${rows.length.toLocaleString()} tickets. Use search to narrow results or export CSV for full data.</td>`;
        tbody.appendChild(tr);
    }
}

function buildDDCols(rows) {
    // Use important mapped columns + any raw columns from Excel
    const cols = [];
    const add = (label, getter) => cols.push({ label, getter });

    // Incident ID
    const idCol = columnMappings.incidentId;
    add('Incident ID', r => idCol ? r[idCol] : r._incidentId || '');
    // Priority
    const priCol = columnMappings.priority;
    add('Priority', r => priCol ? r[priCol] : r._priority || '');
    // Service
    const svcCol = columnMappings.service;
    add('Service', r => svcCol ? r[svcCol] : '');
    // Status
    const statCol = columnMappings.status;
    add('Status', r => statCol ? r[statCol] : '');
    // Status Reason
    const srCol = columnMappings.statusReason;
    if (srCol) add('Status Reason', r => r[srCol] || '');
    // Product
    const prodCol = columnMappings.productName;
    if (prodCol) add('Product', r => r[prodCol] || '');
    // Submit Date
    const sdCol = columnMappings.submitDate;
    add('Submit Date', r => {
        const d = r._submitDate;
        return d ? d.toLocaleDateString() : (sdCol ? r[sdCol] : '');
    });
    // Resolved Date
    const rdCol = columnMappings.resolvedDate;
    if (rdCol) add('Resolved Date', r => {
        const d = r._resolvedDate;
        return d ? d.toLocaleDateString() : (r[rdCol] || '');
    });
    // Net Age
    add('Net Age (hrs)', r => {
        const a = r._ageToUse;
        return a != null ? Math.round(a) : '';
    });
    add('Net Age (days)', r => {
        const a = r._ageToUse;
        return a != null ? (a/24).toFixed(1) : '';
    });
    // Hold Time
    const holdCol = columnMappings.totalTimeOnHold;
    if (holdCol) add('Hold Time (min)', r => r[holdCol] || 0);
    // SLA Target
    add('SLA Target (h)', r => r._slaH || '');
    // Schedule
    add('Schedule', r => r._slaS || '');
    // SLA Status
    add('SLA Status', r => r._calculatedSLA || '');

    return cols.map(c => ({ ...c, isFn: true }));
}

function getCellVal(row, col) {
    if (col.isFn) return col.getter(row);
    return row[col.key] != null ? row[col.key] : '';
}

function formatDDCell(val, col) {
    const s = String(val ?? '');
    const label = (col.label || '').toLowerCase();

    // SLA Status badge
    if (label === 'sla status') {
        const sl = s.toLowerCase();
        if (sl.includes('breach')) return `<span class="dd-badge breached">‚õî BREACHED</span>`;
        if (sl.includes('risk'))   return `<span class="dd-badge risk">‚ö†Ô∏è AT RISK</span>`;
        if (sl.includes('met'))    return `<span class="dd-badge met">‚úÖ MET</span>`;
    }
    // Priority badge
    if (label === 'priority') {
        const pl = s.toLowerCase();
        if (pl === 'critical') return `<span class="dd-badge p1">üî¥ Critical</span>`;
        if (pl === 'high')     return `<span class="dd-badge p2">üü† High</span>`;
        if (pl === 'medium')   return `<span class="dd-badge p3">üîµ Medium</span>`;
        if (pl === 'low')      return `<span class="dd-badge p4">‚ö™ Low</span>`;
    }
    // Age ‚Äî colour code
    if (label.includes('net age (days)')) {
        const n = parseFloat(s);
        if (!isNaN(n)) {
            const color = n > 180 ? '#f87171' : n > 75 ? '#fb923c' : n > 30 ? '#fbbf24' : '#34d399';
            return `<span style="color:${color};font-weight:600">${s}</span>`;
        }
    }
    return s.length > 60 ? s.slice(0,57) + '‚Ä¶' : s;
}

function filterDDTable() {
    const q = document.getElementById('ddSearch').value.toLowerCase();
    _ddRows = q
        ? _ddAllRows.filter(r => {
            return Object.values(r).some(v => String(v ?? '').toLowerCase().includes(q)) ||
                   (r._calculatedSLA||'').toLowerCase().includes(q);
        })
        : _ddAllRows;
    _ddSort = { col: null, asc: true };
    renderDDTable(_ddRows);
}

function sortDDTable(colIdx) {
    const asc = _ddSort.col === colIdx ? !_ddSort.asc : true;
    _ddSort = { col: colIdx, asc };
    const cols = buildDDCols(_ddRows);
    const col = cols[colIdx];
    _ddRows = [..._ddRows].sort((a, b) => {
        let av = getCellVal(a, col), bv = getCellVal(b, col);
        const an = parseFloat(av), bn = parseFloat(bv);
        if (!isNaN(an) && !isNaN(bn)) return asc ? an - bn : bn - an;
        return asc ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
    });
    renderDDTable(_ddRows);
}

function exportDDToCSV() {
    if (!_ddAllRows.length) return;
    const cols = buildDDCols(_ddAllRows);
    const header = cols.map(c => `"${c.label}"`).join(',');
    const rowsCSV = _ddAllRows.map(r =>
        cols.map(c => {
            const v = String(getCellVal(r, c) ?? '').replace(/"/g, '""');
            return `"${v}"`;
        }).join(',')
    );
    const csv = [header, ...rowsCSV].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `tickets_${document.getElementById('ddTitle').textContent.replace(/\s+/g,'_')}.csv`;
    a.click();
}

// ‚îÄ‚îÄ END DRILL-DOWN ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getAge(row) {
    return row._ageToUse || 0;
}

function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
}

const fileInput = document.getElementById('fileInput');
const uploadSection = document.getElementById('uploadSection');
const loading = document.getElementById('loading');
const dashboardContent = document.getElementById('dashboardContent');
const errorMessage = document.getElementById('errorMessage');

fileInput.addEventListener('change', handleFile);

uploadSection.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadSection.classList.add('dragover');
});

uploadSection.addEventListener('dragleave', () => {
    uploadSection.classList.remove('dragover');
});

uploadSection.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadSection.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        handleFile();
    }
});

function handleFile() {
    const file = fileInput.files[0];
    if (!file) return;
    
    if (typeof XLSX === 'undefined') {
        errorMessage.innerHTML = '<div class="error-message">Excel library not loaded</div>';
        return;
    }
    
    document.getElementById('currentFile').innerHTML = `<div class="current-file">‚úÖ ${file.name}</div>`;
    errorMessage.innerHTML = '';
    loading.style.display = 'block';
    dashboardContent.classList.remove('active');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: false, cellNF: false });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            console.log('üìä File loaded:', file.name);
            
            // Check if this is a ROXANNE file with malformed structure
            let rawData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });
            const firstRowKeys = Object.keys(rawData[0] || {});
            const hasEmptyColumns = firstRowKeys.some(k => k.includes('__EMPTY'));
            
            console.log('üìã First attempt - Total rows:', rawData.length);
            console.log('üìë First row keys:', firstRowKeys);
            
            // If we have __EMPTY__ columns, this is a ROXANNE file - use row 2 as headers
            if (hasEmptyColumns || (firstRowKeys.length > 0 && firstRowKeys[0].includes('ROXANNE'))) {
                console.log('üîÑ Detected ROXANNE format - reprocessing with row 2 as headers...');
                
                // Parse without headers first
                const allRows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: false, defval: '' });
                console.log('üìä Raw rows:', allRows.length);
                console.log('üìë Row 1 (title):', allRows[0]);
                console.log('üìë Row 2 (headers):', allRows[1]);
                console.log('üìë Row 3 (first data):', allRows[2]);
                
                if (allRows.length < 3) {
                    throw new Error('ROXANNE file has insufficient rows');
                }
                
                // Row 2 should be the headers
                const headers = allRows[1];
                // Rows 3+ are the data
                const dataRows = allRows.slice(2);
                
                // Convert to objects using row 2 as headers
                rawData = dataRows.map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        if (header && header !== '') {
                            obj[header] = row[index] || '';
                        }
                    });
                    return obj;
                }).filter(obj => Object.keys(obj).length > 0);
                
                console.log('‚úÖ ROXANNE reprocessed - Data rows:', rawData.length);
                console.log('‚úÖ Sample reprocessed row:', rawData[0]);
            }
            
            console.log('üìã Final row count:', rawData.length);
            
            if (rawData.length === 0) throw new Error('No data found in file');
            
            console.log('üîç Detecting columns...');
            columnMappings = detectColumns(rawData);
            console.log('‚úÖ Columns detected:', columnMappings);
            
            console.log('üíæ Enriching data...');
            ticketData = enrichData(rawData, columnMappings);
            filteredData = ticketData;
            
            console.log('‚úÖ Sample enriched row:', filteredData[0]);
            console.log(`üìä Age calculation test - First ticket age: ${filteredData[0]._ageToUse} hours`);
            
            setDefaultDateRange();
            populateFilters();
            initAllTabs();
            processData(filteredData);
            
            loading.style.display = 'none';
            dashboardContent.classList.add('active');
        } catch (error) {
            console.error('‚ùå Error processing file:', error);
            errorMessage.innerHTML = `<div class="error-message">Error: ${error.message}<br>Check browser console (F12) for details</div>`;
            loading.style.display = 'none';
        }
    };
    reader.readAsArrayBuffer(file);
}

function setDefaultDateRange() {
    if (!columnMappings.submitDate) return;
    const dates = ticketData.map(r => r._submitDate).filter(d => d !== null && d !== undefined);
    if (dates.length === 0) return;
    const minDate = new Date(Math.min(...dates));
    const maxDate = new Date(Math.max(...dates));
    document.getElementById('filterDateFrom').value = minDate.toISOString().split('T')[0];
    document.getElementById('filterDateTo').value = maxDate.toISOString().split('T')[0];
}

function populateFilters() {
    const filters = {
        filterService: columnMappings.service,
        filterStatus: columnMappings.status,
        filterPriority: columnMappings.priority,
        filterGroup: columnMappings.assignedGroup,
        filterSLA: columnMappings.slaStatus
    };
    
    Object.entries(filters).forEach(([filterId, columnName]) => {
        const select = document.getElementById(filterId);
        if (!columnName) {
            select.innerHTML = '<option value="">N/A</option>';
            select.disabled = true;
            return;
        }
        select.disabled = false;
        const uniqueValues = [...new Set(ticketData.map(row => {
            const val = row[columnName];
            return val !== null && val !== undefined ? String(val).trim() : '';
        }).filter(v => v !== ''))];
        uniqueValues.sort((a, b) => a.localeCompare(b));
        const placeholder = filterId === 'filterService' ? 'All Services' :
                          filterId === 'filterStatus' ? 'All Statuses' :
                          filterId === 'filterPriority' ? 'All Priorities' :
                          filterId === 'filterGroup' ? 'All Groups' : 'All SLA';
        select.innerHTML = `<option value="">${placeholder}</option>` + 
            uniqueValues.map(value => `<option value="${value}">${value}</option>`).join('');
    });
}

function applyFilters() {
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    
    filteredData = ticketData.filter(row => {
        if (dateFrom || dateTo) {
            const submitDate = row._submitDate;
            if (!submitDate) return false;
            if (dateFrom && submitDate < new Date(dateFrom)) return false;
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59);
                if (submitDate > toDate) return false;
            }
        }
        return (!document.getElementById('filterService').value || String(row[columnMappings.service] || '').trim() === document.getElementById('filterService').value) &&
               (!document.getElementById('filterStatus').value || String(row[columnMappings.status] || '').trim() === document.getElementById('filterStatus').value) &&
               (!document.getElementById('filterPriority').value || String(row[columnMappings.priority] || '').trim() === document.getElementById('filterPriority').value) &&
               (!document.getElementById('filterGroup').value || String(row[columnMappings.assignedGroup] || '').trim() === document.getElementById('filterGroup').value) &&
               (!document.getElementById('filterSLA').value || getSLA(row) === document.getElementById('filterSLA').value);
    });
    
    updateFilterStatus();
    processData(filteredData);
}

function clearFilters() {
    ['filterService', 'filterStatus', 'filterPriority', 'filterGroup', 'filterSLA', 'filterDateFrom', 'filterDateTo'].forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.value = '';
    });
    setDefaultDateRange();
    filteredData = ticketData;
    updateFilterStatus();
    processData(filteredData);
}

function updateFilterStatus() {
    const total = ticketData.length;
    const filtered = filteredData.length;
    document.getElementById('filterStatusText').textContent = 
        filtered === total ? `Showing all ${total.toLocaleString()} tickets` : `Showing ${filtered.toLocaleString()} of ${total.toLocaleString()} tickets`;
}

function generateColorPalette(count) {
    const colors = ['#60a5fa', '#34d399', '#fb923c', '#f87171', '#fbbf24', '#a78bfa', '#38bdf8', '#4ade80', '#facc15', '#c084fc', '#22d3ee', '#86efac', '#fde047', '#e9d5ff', '#bae6fd'];
    return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
}

function processData(data) {
    const countBy = field => {
        if (!field) return {};
        const counts = {};
        data.forEach(row => {
            const val = row[field] !== null && row[field] !== undefined ? String(row[field]).trim() : 'Unknown';
            counts[val] = (counts[val] || 0) + 1;
        });
        return counts;
    };
    
    const slaCounts = {};
    data.forEach(row => {
        const sla = getSLA(row);
        slaCounts[sla] = (slaCounts[sla] || 0) + 1;
    });
    
    const statusCounts = countBy(columnMappings.status);
    const priorityCounts = countBy(columnMappings.priority);
    const impactCounts = countBy(columnMappings.impact);
    const serviceCounts = countBy(columnMappings.service);
    const groupCounts = countBy(columnMappings.assignedGroup);
    const companyCounts = countBy(columnMappings.company);
    
    updateKPIs(data, slaCounts);
    updateServiceHealth(data, serviceCounts);
    updateAgingChart(data);
    updatePrioritySLAChart(data, priorityCounts);
    updateTopCompaniesChart(companyCounts);
    updateChart('statusChart', 'doughnut', Object.keys(statusCounts), Object.values(statusCounts), ['#fb923c', '#60a5fa', '#34d399', '#a78bfa']);
    updateChart('priorityChart', 'pie', Object.keys(priorityCounts), Object.values(priorityCounts), ['#34d399', '#fb923c', '#f87171']);
    updateBarChart('slaChart', Object.keys(slaCounts), Object.values(slaCounts));
    updateChart('impactChart', 'bar', Object.keys(impactCounts), Object.values(impactCounts), ['#60a5fa']);
    updateServicesTable(data, serviceCounts);
    updateTeamPerformance(data, groupCounts);
    updateTopServicesChart(serviceCounts);
    updateTopGroupsChart(groupCounts);
    updateTemporalTables(data);
}

function updateKPIs(data, sla) {
    const total = data.length;
    let breached = 0, met = 0;
    Object.entries(sla).forEach(([s, count]) => {
        const lower = s.toLowerCase();
        if (lower.includes('breach')) breached += count;
        else if (lower.includes('met') || lower.includes('within')) met += count;
    });
    
    const atRisk = data.filter(r => {
        const ageDays = getAge(r) / 24;
        return ageDays >= 3 && ageDays <= 7;
    }).length;
    
    const ages = data.map(r => getAge(r)).filter(a => a > 0);
    const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length / 24) : 0;
    const maxAge = ages.length > 0 ? Math.round(Math.max(...ages) / 24) : 0;
    const aging180 = ages.filter(a => a / 24 > 180).length;
    const over75 = ages.filter(a => a / 24 > 75).length;
    const rate = total > 0 ? ((breached / total) * 100).toFixed(1) : 0;
    
    const kpiGrid = document.getElementById('kpiGrid');
    if (kpiGrid) {
        kpiGrid.innerHTML = `
            <div class="kpi-card" onclick="openDrilldown(filteredData,'All Tickets','Complete ticket list')"><div class="kpi-label">Total</div><div class="kpi-value">${total.toLocaleString()}</div></div>
            <div class="kpi-card critical" onclick="openDrilldown(filteredData.filter(r=>getSLA(r).toLowerCase().includes('breach')),'SLA Breached','Tickets that exceeded their SLA target')"><div class="kpi-label">SLA Breached</div><div class="kpi-value">${breached.toLocaleString()}</div><div class="kpi-subtitle">Rate: ${rate}%</div></div>
            <div class="kpi-card success" onclick="openDrilldown(filteredData.filter(r=>getSLA(r).toLowerCase().includes('met')&&!getSLA(r).toLowerCase().includes('breach')),'SLA Met','Tickets within SLA target')"><div class="kpi-label">SLA Met</div><div class="kpi-value">${met.toLocaleString()}</div></div>
            <div class="kpi-card warning" onclick="openDrilldown(filteredData.filter(r=>getSLA(r).toLowerCase().includes('risk')),'At Risk','Tickets at 75-100% of SLA target')"><div class="kpi-label">At Risk (3-7d)</div><div class="kpi-value">${atRisk.toLocaleString()}</div></div>
            <div class="kpi-card" onclick="openDrilldown(filteredData,'All Tickets (sorted by age)','Click Net Age column header to sort')"><div class="kpi-label">Avg Age</div><div class="kpi-value">${avgAge}</div></div>
            <div class="kpi-card" onclick="openDrilldown(filteredData,'All Tickets (sorted by age)','Click Net Age column header to sort')"><div class="kpi-label">Max Age</div><div class="kpi-value">${maxAge}</div></div>
            <div class="kpi-card warning" onclick="openDrilldown(filteredData.filter(r=>getAge(r)/24>75),'Tickets Over 75 Days','Aged tickets exceeding 75 business days')"><div class="kpi-label">>75 Days</div><div class="kpi-value">${over75.toLocaleString()}</div></div>
            <div class="kpi-card critical" onclick="openDrilldown(filteredData.filter(r=>getAge(r)/24>180),'üö® Tickets Over 180 Days','Critical aging ‚Äî exceeded 180 business days')"><div class="kpi-label">üö® >180 Days</div><div class="kpi-value">${aging180.toLocaleString()}</div></div>
        `;
    }
}

function updateServiceHealth(data, svc) {
    const services = Object.entries(svc).map(([service, count]) => {
        const serviceData = data.filter(r => String(r[columnMappings.service]).trim() === service);
        const breached = serviceData.filter(r => getSLA(r).toLowerCase().includes('breach')).length;
        const rate = (breached / count) * 100;
        
        let health, healthClass, icon;
        if (rate < 10) {
            health = 'Excellent';
            healthClass = 'excellent';
            icon = 'üü¢';
        } else if (rate < 25) {
            health = 'Good';
            healthClass = 'good';
            icon = 'üü°';
        } else if (rate < 50) {
            health = 'Warning';
            healthClass = 'warning';
            icon = 'üü†';
        } else {
            health = 'Critical';
            healthClass = 'critical';
            icon = 'üî¥';
        }
        
        return { service, count, rate: rate.toFixed(1), health, healthClass, icon };
    }).sort((a, b) => b.count - a.count).slice(0, 10);
    
    let html = '';
    window._serviceTicketCache = {};
    services.forEach(s => {
        const svcRows = data.filter(r => String(r[columnMappings.service] || '').trim() === s.service);
        window._serviceTicketCache[s.service] = svcRows;
        const eid = 'svc_' + s.service.replace(/[^a-z0-9]/gi,'_');
        html += `
            <div class="metric-item" id="${eid}" style="cursor:pointer" onclick="openDrilldown(window._serviceTicketCache['${s.service.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}'], '${s.service.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}', '${s.count} tickets ‚Ä¢ Breach rate: ${s.rate}%')">
                <div class="metric-item-label">${s.service}</div>
                <div class="metric-item-value">${s.count.toLocaleString()}</div>
                <div style="margin-top:8px">
                    <span class="health-badge ${s.healthClass}">${s.icon} ${s.health}</span>
                    <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px">Breach: ${s.rate}%</div>
                </div>
            </div>
        `;
    });
    
    const grid = document.getElementById('serviceHealthGrid');
    if (grid) grid.innerHTML = html;
}

function updateAgingChart(data) {
    const ages = data.map(r => getAge(r)).filter(a => a > 0);
    const buckets = {
        '0-7 days': ages.filter(a => a / 24 <= 7).length,
        '8-30 days': ages.filter(a => a / 24 > 7 && a / 24 <= 30).length,
        '31-90 days': ages.filter(a => a / 24 > 30 && a / 24 <= 90).length,
        '91-180 days': ages.filter(a => a / 24 > 90 && a / 24 <= 180).length,
        '180+ days': ages.filter(a => a / 24 > 180).length
    };
    
    destroyChart('agingChart');
    const ctx = document.getElementById('agingChart');
    if (!ctx) return;
    
    chartInstances.agingChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(buckets),
            datasets: [{
                label: 'Tickets',
                data: Object.values(buckets),
                backgroundColor: ['#34d399', '#60a5fa', '#fbbf24', '#fb923c', '#f87171'],
                borderWidth: 0
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                y: { beginAtZero: true, grid: { color: '#334155' } },
                x: { grid: { display: false } }
            }
        }
    });
}

function updatePrioritySLAChart(data, priorityCounts) {
    const priorities = Object.keys(priorityCounts);
    const breached = priorities.map(p => 
        data.filter(r => String(r[columnMappings.priority]).trim() === p && getSLA(r).toLowerCase().includes('breach')).length
    );
    const met = priorities.map(p => 
        data.filter(r => String(r[columnMappings.priority]).trim() === p && (getSLA(r).toLowerCase().includes('met') || getSLA(r).toLowerCase().includes('within'))).length
    );
    
    destroyChart('prioritySLAChart');
    const ctx = document.getElementById('prioritySLAChart');
    if (!ctx) return;
    
    chartInstances.prioritySLAChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: priorities,
            datasets: [
                { label: 'Breached', data: breached, backgroundColor: '#f87171', borderWidth: 0 },
                { label: 'Met', data: met, backgroundColor: '#34d399', borderWidth: 0 }
            ]
        },
        options: {
            ...chartOptions,
            scales: {
                y: { beginAtZero: true, grid: { color: '#334155' } },
                x: { grid: { display: false } }
            }
        }
    });
}

function updateTopCompaniesChart(companyCounts) {
    const top = Object.entries(companyCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const colors = generateColorPalette(top.length);
    
    destroyChart('topCompaniesChart');
    const ctx = document.getElementById('topCompaniesChart');
    if (!ctx) return;
    
    chartInstances.topCompaniesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top.map(c => c[0]),
            datasets: [{
                label: 'Total Tickets',
                data: top.map(c => c[1]),
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            ...chartOptions,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true, grid: { color: '#334155' } },
                y: { grid: { display: false } }
            }
        }
    });
}

function updateServicesTable(data, serviceCounts) {
    const services = Object.entries(serviceCounts).map(([service, count]) => {
        const serviceData = data.filter(r => String(r[columnMappings.service]).trim() === service);
        const breached = serviceData.filter(r => getSLA(r).toLowerCase().includes('breach')).length;
        const rate = (breached / count) * 100;
        
        let healthBadge;
        if (rate < 10) {
            healthBadge = '<span class="health-badge excellent">üü¢ Excellent</span>';
        } else if (rate < 25) {
            healthBadge = '<span class="health-badge good">üü° Good</span>';
        } else if (rate < 50) {
            healthBadge = '<span class="health-badge warning">üü† Warning</span>';
        } else {
            healthBadge = '<span class="health-badge critical">üî¥ Critical</span>';
        }
        
        return {
            service,
            count,
            pct: ((count / data.length) * 100).toFixed(2),
            rate: rate.toFixed(1),
            badge: healthBadge
        };
    }).sort((a, b) => b.count - a.count);
    
    const tbody = document.getElementById('servicesTableBody');
    if (tbody) {
        window._serviceTableCache = {};
        services.forEach(s => {
            window._serviceTableCache[s.service] = data.filter(r => String(r[columnMappings.service] || '').trim() === s.service);
        });
        tbody.innerHTML = services.map(s => `
            <tr style="cursor:pointer" onclick="openDrilldown(window._serviceTableCache['${s.service.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}'], '${s.service.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}', '${s.count} tickets | Breach: ${s.rate}%')" title="Click to see tickets for ${s.service}">
                <td>${s.service}</td>
                <td style="color:#60a5fa;font-weight:600">${s.count.toLocaleString()}</td>
                <td style="color:#fb923c;font-weight:600">${s.pct}%</td>
                <td style="color:#f87171;font-weight:600">${s.rate}%</td>
                <td>${s.badge}</td>
            </tr>
        `).join('');
    }
}

function updateTeamPerformance(data, groupCounts) {
    const teams = Object.entries(groupCounts).map(([team, count]) => {
        const teamData = data.filter(r => String(r[columnMappings.assignedGroup]).trim() === team);
        const breached = teamData.filter(r => getSLA(r).toLowerCase().includes('breach')).length;
        const rate = (breached / count) * 100;
        const ages = teamData.map(r => getAge(r)).filter(a => a > 0);
        const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length / 24) : 0;
        
        let perfBadge;
        if (rate < 15 && avgAge < 30) {
            perfBadge = '<span class="health-badge excellent">üü¢ Excellent</span>';
        } else if (rate < 30 && avgAge < 60) {
            perfBadge = '<span class="health-badge good">üü° Good</span>';
        } else if (rate < 50) {
            perfBadge = '<span class="health-badge warning">üü† Warning</span>';
        } else {
            perfBadge = '<span class="health-badge critical">üî¥ Needs Improvement</span>';
        }
        
        return { team, count, rate: rate.toFixed(1), avgAge, badge: perfBadge };
    }).sort((a, b) => b.count - a.count);
    
    const tbody = document.getElementById('teamPerformanceBody');
    if (tbody) {
        window._teamTableCache = {};
        teams.forEach(t => {
            window._teamTableCache[t.team] = data.filter(r => String(r[columnMappings.assignedGroup] || '').trim() === t.team);
        });
        tbody.innerHTML = teams.map(t => `
            <tr style="cursor:pointer" onclick="openDrilldown(window._teamTableCache['${t.team.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}'], '${t.team.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}', '${t.count} tickets | Breach: ${t.rate}%')" title="Click to see tickets for ${t.team}">
                <td>${t.team}</td>
                <td style="color:#60a5fa;font-weight:600">${t.count.toLocaleString()}</td>
                <td style="color:#f87171;font-weight:600">${t.rate}%</td>
                <td style="color:#fb923c;font-weight:600">${t.avgAge}</td>
                <td>${t.badge}</td>
            </tr>
        `).join('');
    }
}

function destroyChart(chartId) {
    if (chartInstances[chartId]) {
        chartInstances[chartId].destroy();
        delete chartInstances[chartId];
    }
}

function updateChart(chartId, type, labels, values, colors) {
    destroyChart(chartId);
    const ctx = document.getElementById(chartId);
    if (!ctx) return;
    
    chartInstances[chartId] = new Chart(ctx, {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: type === 'doughnut' ? { ...chartOptions, cutout: '65%' } : chartOptions
    });
}

function updateBarChart(chartId, labels, values) {
    destroyChart(chartId);
    const ctx = document.getElementById(chartId);
    if (!ctx) return;
    
    const colors = labels.map(l => {
        const lower = l.toLowerCase();
        if (lower.includes('breach')) return '#f87171';
        if (lower.includes('met') || lower.includes('within')) return '#34d399';
        return '#60a5fa';
    });
    
    chartInstances[chartId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tickets',
                data: values,
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                y: { beginAtZero: true, grid: { color: '#334155' } },
                x: { grid: { display: false } }
            }
        }
    });
}

function updateTopServicesChart(serviceCounts) {
    const top = Object.entries(serviceCounts).sort((a, b) => b[1] - a[1]).slice(0, 15);
    const colors = generateColorPalette(top.length);
    
    destroyChart('topServicesChart');
    const ctx = document.getElementById('topServicesChart');
    if (!ctx) return;
    
    chartInstances.topServicesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top.map(s => s[0]),
            datasets: [{
                label: 'Tickets',
                data: top.map(s => s[1]),
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            ...chartOptions,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true, grid: { color: '#334155' } },
                y: { grid: { display: false } }
            }
        }
    });
}

function updateTopGroupsChart(groupCounts) {
    const top = Object.entries(groupCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const colors = generateColorPalette(top.length);
    
    destroyChart('topGroupsChart');
    const ctx = document.getElementById('topGroupsChart');
    if (!ctx) return;
    
    chartInstances.topGroupsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top.map(g => g[0]),
            datasets: [{
                label: 'Tickets',
                data: top.map(g => g[1]),
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            ...chartOptions,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true, grid: { color: '#334155' } },
                y: { grid: { display: false } }
            }
        }
    });
}

function updateTemporalTables(data) {
    const statusReasonCol = columnMappings.statusReason;
    const serviceCol = columnMappings.service;
    
    if (!statusReasonCol || !serviceCol) {
        ['dailyTableBody', 'monthlyTableBody', 'carryoverTableBody'].forEach(id => {
            const elem = document.getElementById(id);
            if (elem) elem.innerHTML = '<tr><td colspan="5">Data not available</td></tr>';
        });
        return;
    }
    
    const daily = data.filter(r => getAge(r) / 24 <= 7);
    const monthly = data.filter(r => {
        const ageDays = getAge(r) / 24;
        return ageDays > 7 && ageDays <= 30;
    });
    const carryover = data.filter(r => getAge(r) / 24 > 30);
    
    function populateTable(tableBodyId, filteredData) {
        const reasons = [...new Set(filteredData.map(r => r[statusReasonCol]))].filter(r => r && r !== 'Unknown');
        let html = '';
        
        reasons.slice(0, 20).forEach(reason => {
            const reasonData = filteredData.filter(r => r[statusReasonCol] === reason);
            const services = [...new Set(reasonData.map(r => r[serviceCol]))].slice(0, 5);
            
            services.forEach(service => {
                const serviceData = reasonData.filter(r => r[serviceCol] === service);
                const breached = serviceData.filter(r => getSLA(r).toLowerCase().includes('breach')).length;
                const met = serviceData.filter(r => {
                    const sla = getSLA(r).toLowerCase();
                    return sla.includes('met') || sla.includes('within');
                }).length;
                
                html += `
                    <tr style="cursor:pointer" onclick="openDrilldown(window._ddTmpCache['${reason.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;')}_${service.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;')}'] || [], '${reason.replace(/'/g,"\\'")} ‚Äî ${service.replace(/'/g,"\\'")}', '${serviceData.length} tickets | Breached: ${breached} | Met: ${met}')" title="Click to view tickets">
                        <td>${reason}</td>
                        <td>${service}</td>
                        <td><span class="badge breached">${breached}</span></td>
                        <td><span class="badge met">${met}</span></td>
                        <td style="font-weight:600">${serviceData.length}</td>
                    </tr>
                `;
                window._ddTmpCache = window._ddTmpCache || {};
                window._ddTmpCache[`${reason}_${service}`] = serviceData;
            });
        });
        
        const tbody = document.getElementById(tableBodyId);
        if (tbody) {
            tbody.innerHTML = html || '<tr><td colspan="5">No data</td></tr>';
        }
    }
    
    populateTable('dailyTableBody', daily);
    populateTable('monthlyTableBody', monthly);
    populateTable('carryoverTableBody', carryover);
}
    </script>
</body>
</html>
